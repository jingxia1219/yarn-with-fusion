"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
var _exportNames = {
  SkipPrepareToken: true,
  ProviderPlugin: true,
  ProvidedHOC: true,
  Provider: true,
  FusionContext: true,
  ServiceConsumer: true,
  ServiceContext: true,
  useService: true,
  withServices: true
};
Object.defineProperty(exports, "ProviderPlugin", {
  enumerable: true,
  get: function () {
    return _plugin.default;
  }
});
Object.defineProperty(exports, "ProvidedHOC", {
  enumerable: true,
  get: function () {
    return _hoc.default;
  }
});
Object.defineProperty(exports, "Provider", {
  enumerable: true,
  get: function () {
    return _provider.default;
  }
});
Object.defineProperty(exports, "FusionContext", {
  enumerable: true,
  get: function () {
    return _context.FusionContext;
  }
});
Object.defineProperty(exports, "ServiceConsumer", {
  enumerable: true,
  get: function () {
    return _context.ServiceConsumer;
  }
});
Object.defineProperty(exports, "ServiceContext", {
  enumerable: true,
  get: function () {
    return _context.ServiceContext;
  }
});
Object.defineProperty(exports, "useService", {
  enumerable: true,
  get: function () {
    return _context.useService;
  }
});
Object.defineProperty(exports, "withServices", {
  enumerable: true,
  get: function () {
    return _context.withServices;
  }
});
exports.default = exports.SkipPrepareToken = void 0;

var React = _interopRequireWildcard(require("react"));

var _fusionCore = _interopRequireWildcard(require("fusion-core"));

var _index = require("./async/index.js");

Object.keys(_index).forEach(function (key) {
  if (key === "default" || key === "__esModule") return;
  if (Object.prototype.hasOwnProperty.call(_exportNames, key)) return;
  if (key in exports && exports[key] === _index[key]) return;
  Object.defineProperty(exports, key, {
    enumerable: true,
    get: function () {
      return _index[key];
    }
  });
});

var _prepareProvider = _interopRequireDefault(require("./async/prepare-provider"));

var _fusionTokens = require("fusion-tokens");

var _client = _interopRequireDefault(require("./client"));

var _plugin = _interopRequireDefault(require("./plugin"));

var _hoc = _interopRequireDefault(require("./hoc"));

var _provider = _interopRequireDefault(require("./provider"));

var _context = require("./context.js");

var _jsxRuntime = require("react/jsx-runtime");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */

/* eslint-env browser */
const SkipPrepareToken = (0, _fusionCore.createToken)('SkipPrepareToken');
exports.SkipPrepareToken = SkipPrepareToken;

class App extends _fusionCore.default {
  constructor(root, render) {
    if (! /*#__PURE__*/React.isValidElement(root)) {
      throw new Error('Invalid React element. Ensure your root element is a React.Element (e.g. <Foo />) and not a React.Component (e.g. Foo)');
    }

    const getService = token => {
      // $FlowFixMe
      const provides = this.getService(token);
      const isRequiredToken = Boolean(token.optional);

      if (typeof provides === 'undefined' && isRequiredToken) {
        throw new Error(`Token ${token.name} not registered or registered plugin does not provide a service. To use an optional plugin, use \`Token.optional\`.`);
      }

      return provides;
    };

    const renderer = (0, _fusionCore.createPlugin)({
      deps: {
        criticalChunkIds: _fusionCore.CriticalChunkIdsToken.optional,
        skipPrepare: SkipPrepareToken.optional,
        logger: _fusionTokens.LoggerToken.optional
      },

      provides({
        skipPrepare,
        logger
      }) {
        return (el, ctx) => {
          return (skipPrepare ? Promise.resolve() : (0, _index.prepare)(el, ctx)).catch(() => {}) // recover from failed `prepare`
          .then(() => {
            if (render) {
              return render(el, ctx);
            }

            if (false) {
              return serverRender(el, logger);
            } else {
              return (0, _client.default)(el);
            }
          });
        };
      },

      middleware({
        criticalChunkIds
      }) {
        return (ctx, next) => {
          if (false && !ctx.element) {
            return next();
          }

          const markAsCritical = false ? chunkId => {
            // Push to legacy context for backwards compat w/ legacy SSR template
            ctx.preloadChunks.push(chunkId); // Also use new service if registered

            if (criticalChunkIds) {
              let chunkIds = criticalChunkIds.from(ctx);
              chunkIds.add(chunkId);
            }
          } : noop; // This is used to collect arbitrary metadata during a given SSR
          // The primary use case is to collect bundler-specific information
          // about import() statements encountered during SSR so that async
          // bundle-split client code can be preloaded/fetched appropriately

          ctx.ssrMetadata = [];
          const pushSSRMetadata = false ? metadata => {
            ctx.ssrMetadata.push(metadata);
          } : noop;
          ctx.element = /*#__PURE__*/(0, _jsxRuntime.jsx)(_prepareProvider.default, {
            markAsCritical: markAsCritical,
            pushSSRMetadata: pushSSRMetadata,
            children: /*#__PURE__*/(0, _jsxRuntime.jsx)(_context.FusionContext.Provider, {
              value: ctx,
              children: /*#__PURE__*/(0, _jsxRuntime.jsx)(_context.ServiceContext.Provider, {
                value: getService,
                children: ctx.element
              })
            })
          });
          return next();
        };
      }

    });
    super(root, renderer);
  }

}

exports.default = App;

function noop() {}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJTa2lwUHJlcGFyZVRva2VuIiwiQXBwIiwiRnVzaW9uQXBwIiwiY29uc3RydWN0b3IiLCJyb290IiwicmVuZGVyIiwiUmVhY3QiLCJpc1ZhbGlkRWxlbWVudCIsIkVycm9yIiwiZ2V0U2VydmljZSIsInRva2VuIiwicHJvdmlkZXMiLCJpc1JlcXVpcmVkVG9rZW4iLCJCb29sZWFuIiwib3B0aW9uYWwiLCJuYW1lIiwicmVuZGVyZXIiLCJkZXBzIiwiY3JpdGljYWxDaHVua0lkcyIsIkNyaXRpY2FsQ2h1bmtJZHNUb2tlbiIsInNraXBQcmVwYXJlIiwibG9nZ2VyIiwiTG9nZ2VyVG9rZW4iLCJlbCIsImN0eCIsIlByb21pc2UiLCJyZXNvbHZlIiwiY2F0Y2giLCJ0aGVuIiwic2VydmVyUmVuZGVyIiwibWlkZGxld2FyZSIsIm5leHQiLCJlbGVtZW50IiwibWFya0FzQ3JpdGljYWwiLCJjaHVua0lkIiwicHJlbG9hZENodW5rcyIsInB1c2giLCJjaHVua0lkcyIsImZyb20iLCJhZGQiLCJub29wIiwic3NyTWV0YWRhdGEiLCJwdXNoU1NSTWV0YWRhdGEiLCJtZXRhZGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBU0E7O0FBRUE7O0FBTUE7O0FBZ0lBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBL0hBOztBQUNBOztBQUdBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOzs7Ozs7Ozs7O0FBNUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBNEJPLE1BQU1BLGdCQUFnQixHQUFHLDZCQUFxQixrQkFBckIsQ0FBekI7OztBQU1RLE1BQU1DLEdBQU4sU0FBa0JDLG1CQUFsQixDQUE0QjtBQUN6Q0MsRUFBQUEsV0FBVyxDQUFDQyxJQUFELEVB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QWUsUUFBZjtBQUF3QixjQUFBLEtBQUssRUFBRWxCLEdBQS9CO0FBQUEscUNBQ0UscUJBQUMsdUJBQUQsQ0FBZ0IsUUFBaEI7QUFBeUIsZ0JBQUEsS0FBSyxFQUFFZixVQUFoQztBQUFBLDBCQUNHZSxHQUFHLENBQUNRO0FBRFA7QUFERjtBQUpGLFlBREY7QUFZQSxpQkFBT0QsSUFBSSxFQUFYO0FBQ0QsU0ExQ0Q7QUEyQ0Q7O0FBbEUyQixLQUFiLENBQWpCO0FBb0VBLFVBQU0zQixJQUFOLEVBQVlZLFFBQVo7QUFDRDs7QUF2RndDOzs7O0FBcUczQyxTQUFTd0IsSUFBVCxHQUFnQixDQUFFIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKi9cblxuLyogZXNsaW50LWVudiBicm93c2VyICovXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBGdXNpb25BcHAsIHtcbiAgY3JlYXRlVG9rZW4sXG4gIGNyZWF0ZVBsdWdpbixcbiAgQ3JpdGljYWxDaHVua0lkc1Rva2VuLFxuICB0eXBlIENvbnRleHQsXG59IGZyb20gJ2Z1c2lvbi1jb3JlJztcbmltcG9ydCB7cHJlcGFyZX0gZnJvbSAnLi9hc3luYy9pbmRleC5qcyc7XG5pbXBvcnQgUHJlcGFyZVByb3ZpZGVyIGZyb20gJy4vYXN5bmMvcHJlcGFyZS1wcm92aWRlcic7XG5pbXBvcnQge0xvZ2dlclRva2VufSBmcm9tICdmdXNpb24tdG9rZW5zJztcblxuaW1wb3J0IHNlcnZlclJlbmRlciBmcm9tICcuL3NlcnZlcic7XG5pbXBvcnQgY2xpZW50UmVuZGVyIGZyb20gJy4vY2xpZW50JztcblxuaW1wb3J0IFByb3ZpZGVyUGx1Z2luIGZyb20gJy4vcGx1Z2luJztcbmltcG9ydCBQcm92aWRlZEhPQyBmcm9tICcuL2hvYyc7XG5pbXBvcnQgUHJvdmlkZXIgZnJvbSAnLi9wcm92aWRlcic7XG5cbmltcG9ydCB7XG4gIEZ1c2lvbkNvbnRleHQsXG4gIFNlcnZpY2VDb25zdW1lcixcbiAgU2VydmljZUNvbnRleHQsXG4gIHVzZVNlcnZpY2UsXG4gIHdpdGhTZXJ2aWNlcyxcbn0gZnJvbSAnLi9jb250ZXh0LmpzJztcblxuZXhwb3J0IGNvbnN0IFNraXBQcmVwYXJlVG9rZW4gPSBjcmVhdGVUb2tlbjxib29sZWFuPignU2tpcFByZXBhcmVUb2tlbicpO1xuXG5leHBvcnQgdHlwZSBSZW5kZXIgPSAoZWw6IFJlYWN0LkVsZW1lbnQ8Kj4sIGNvbnRleHQ6IENvbnRleHQpID0+IGFueTtcblxuZGVjbGFyZSB2YXIgX19OT0RFX186IEJvb2xlYW47XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcCBleHRlbmRzIEZ1c2lvbkFwcCB7XG4gIGNvbnN0cnVjdG9yKHJvb3Q6IFJlYWN0LkVsZW1lbnQ8Kj4sIHJlbmRlcjogP1JlbmRlcikge1xuICAgIGlmICghUmVhY3QuaXNWYWxpZEVsZW1lbnQocm9vdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0ludmFsaWQgUmVhY3QgZWxlbWVudC4gRW5zdXJlIHlvdXIgcm9vdCBlbGVtZW50IGlzIGEgUmVhY3QuRWxlbWVudCAoZS5nLiA8Rm9vIC8+KSBhbmQgbm90IGEgUmVhY3QuQ29tcG9uZW50IChlLmcuIEZvbyknXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCBnZXRTZXJ2aWNlID0gKHRva2VuKSA9PiB7XG4gICAgICAvLyAkRmxvd0ZpeE1lXG4gICAgICBjb25zdCBwcm92aWRlcyA9IHRoaXMuZ2V0U2VydmljZSh0b2tlbik7XG4gICAgICBjb25zdCBpc1JlcXVpcmVkVG9rZW4gPSBCb29sZWFuKHRva2VuLm9wdGlvbmFsKTtcbiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZXMgPT09ICd1bmRlZmluZWQnICYmIGlzUmVxdWlyZWRUb2tlbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFRva2VuICR7dG9rZW4ubmFtZX0gbm90IHJlZ2lzdGVyZWQgb3IgcmVnaXN0ZXJlZCBwbHVnaW4gZG9lcyBub3QgcHJvdmlkZSBhIHNlcnZpY2UuIFRvIHVzZSBhbiBvcHRpb25hbCBwbHVnaW4sIHVzZSBcXGBUb2tlbi5vcHRpb25hbFxcYC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcHJvdmlkZXM7XG4gICAgfTtcbiAgICBjb25zdCByZW5kZXJlciA9IGNyZWF0ZVBsdWdpbih7XG4gICAgICBkZXBzOiB7XG4gICAgICAgIGNyaXRpY2FsQ2h1bmtJZHM6IENyaXRpY2FsQ2h1bmtJZHNUb2tlbi5vcHRpb25hbCxcbiAgICAgICAgc2tpcFByZXBhcmU6IFNraXBQcmVwYXJlVG9rZW4ub3B0aW9uYWwsXG4gICAgICAgIGxvZ2dlcjogTG9nZ2VyVG9rZW4ub3B0aW9uYWwsXG4gICAgICB9LFxuICAgICAgcHJvdmlkZXMoe3NraXBQcmVwYXJlLCBsb2dnZXJ9KSB7XG4gICAgICAgIHJldHVybiAoZWw6IFJlYWN0LkVsZW1lbnQ8Kj4sIGN0eCkgPT4ge1xuICAgICAgICAgIHJldHVybiAoc2tpcFByZXBhcmUgPyBQcm9taXNlLnJlc29sdmUoKSA6IHByZXBhcmUoZWwsIGN0eCkpXG4gICAgICAgICAgICAuY2F0Y2goKCkgPT4ge30pIC8vIHJlY292ZXIgZnJvbSBmYWlsZWQgYHByZXBhcmVgXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZW5kZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVuZGVyKGVsLCBjdHgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChfX05PREVfXykge1xuICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2ZXJSZW5kZXIoZWwsIGxvZ2dlcik7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsaWVudFJlbmRlcihlbCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIG1pZGRsZXdhcmUoe2NyaXRpY2FsQ2h1bmtJZHN9KSB7XG4gICAgICAgIHJldHVybiAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgaWYgKF9fTk9ERV9fICYmICFjdHguZWxlbWVudCkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBtYXJrQXNDcml0aWNhbCA9IF9fTk9ERV9fXG4gICAgICAgICAgICA/IChjaHVua0lkKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gUHVzaCB0byBsZWdhY3kgY29udGV4dCBmb3IgYmFja3dhcmRzIGNvbXBhdCB3LyBsZWdhY3kgU1NSIHRlbXBsYXRlXG4gICAgICAgICAgICAgICAgY3R4LnByZWxvYWRDaHVua3MucHVzaChjaHVua0lkKTtcblxuICAgICAgICAgICAgICAgIC8vIEFsc28gdXNlIG5ldyBzZXJ2aWNlIGlmIHJlZ2lzdGVyZWRcbiAgICAgICAgICAgICAgICBpZiAoY3JpdGljYWxDaHVua0lkcykge1xuICAgICAgICAgICAgICAgICAgbGV0IGNodW5rSWRzID0gY3JpdGljYWxDaHVua0lkcy5mcm9tKGN0eCk7XG4gICAgICAgICAgICAgICAgICBjaHVua0lkcy5hZGQoY2h1bmtJZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICA6IG5vb3A7XG5cbiAgICAgICAgICAvLyBUaGlzIGlzIHVzZWQgdG8gY29sbGVjdCBhcmJpdHJhcnkgbWV0YWRhdGEgZHVyaW5nIGEgZ2l2ZW4gU1NSXG4gICAgICAgICAgLy8gVGhlIHByaW1hcnkgdXNlIGNhc2UgaXMgdG8gY29sbGVjdCBidW5kbGVyLXNwZWNpZmljIGluZm9ybWF0aW9uXG4gICAgICAgICAgLy8gYWJvdXQgaW1wb3J0KCkgc3RhdGVtZW50cyBlbmNvdW50ZXJlZCBkdXJpbmcgU1NSIHNvIHRoYXQgYXN5bmNcbiAgICAgICAgICAvLyBidW5kbGUtc3BsaXQgY2xpZW50IGNvZGUgY2FuIGJlIHByZWxvYWRlZC9mZXRjaGVkIGFwcHJvcHJpYXRlbHlcbiAgICAgICAgICBjdHguc3NyTWV0YWRhdGEgPSBbXTtcbiAgICAgICAgICBjb25zdCBwdXNoU1NSTWV0YWRhdGEgPSBfX05PREVfX1xuICAgICAgICAgICAgPyAobWV0YWRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBjdHguc3NyTWV0YWRhdGEucHVzaChtZXRhZGF0YSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIDogbm9vcDtcblxuICAgICAgICAgIGN0eC5lbGVtZW50ID0gKFxuICAgICAgICAgICAgPFByZXBhcmVQcm92aWRlclxuICAgICAgICAgICAgICBtYXJrQXNDcml0aWNhbD17bWFya0FzQ3JpdGljYWx9XG4gICAgICAgICAgICAgIHB1c2hTU1JNZXRhZGF0YT17cHVzaFNTUk1ldGFkYXRhfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICA8RnVzaW9uQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17Y3R4fT5cbiAgICAgICAgICAgICAgICA8U2VydmljZUNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2dldFNlcnZpY2V9PlxuICAgICAgICAgICAgICAgICAge2N0eC5lbGVtZW50fVxuICAgICAgICAgICAgICAgIDwvU2VydmljZUNvbnRleHQuUHJvdmlkZXI+XG4gICAgICAgICAgICAgIDwvRnVzaW9uQ29udGV4dC5Qcm92aWRlcj5cbiAgICAgICAgICAgIDwvUHJlcGFyZVByb3ZpZGVyPlxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgc3VwZXIocm9vdCwgcmVuZGVyZXIpO1xuICB9XG59XG5cbmV4cG9ydCB7XG4gIEZ1c2lvbkNvbnRleHQsXG4gIFByb3ZpZGVyUGx1Z2luLFxuICBQcm92aWRlZEhPQyxcbiAgUHJvdmlkZXIsXG4gIFNlcnZpY2VDb25zdW1lcixcbiAgU2VydmljZUNvbnRleHQsXG4gIHVzZVNlcnZpY2UsXG4gIHdpdGhTZXJ2aWNlcyxcbn07XG5cbmZ1bmN0aW9uIG5vb3AoKSB7fVxuXG5leHBvcnQgKiBmcm9tICcuL2FzeW5jL2luZGV4LmpzJztcbiJdfQ==