/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */

/* eslint-env browser */
import * as React from 'react';
import FusionApp, { createToken, createPlugin, CriticalChunkIdsToken } from 'fusion-core';
import { prepare } from './async/index.js';
import PrepareProvider from './async/prepare-provider';
import { LoggerToken } from 'fusion-tokens';
import clientRender from './client';
import ProviderPlugin from './plugin';
import ProvidedHOC from './hoc';
import Provider from './provider';
import { FusionContext, ServiceConsumer, ServiceContext, useService, withServices } from './context.js';
import { jsx as _jsx } from "react/jsx-runtime";
export const SkipPrepareToken = createToken('SkipPrepareToken');
export default class App extends FusionApp {
  constructor(root, render) {
    if (! /*#__PURE__*/React.isValidElement(root)) {
      throw new Error('Invalid React element. Ensure your root element is a React.Element (e.g. <Foo />) and not a React.Component (e.g. Foo)');
    }

    const getService = token => {
      // $FlowFixMe
      const provides = this.getService(token);
      const isRequiredToken = Boolean(token.optional);

      if (typeof provides === 'undefined' && isRequiredToken) {
        throw new Error(`Token ${token.name} not registered or registered plugin does not provide a service. To use an optional plugin, use \`Token.optional\`.`);
      }

      return provides;
    };

    const renderer = createPlugin({
      deps: {
        criticalChunkIds: CriticalChunkIdsToken.optional,
        skipPrepare: SkipPrepareToken.optional,
        logger: LoggerToken.optional
      },

      provides({
        skipPrepare,
        logger
      }) {
        return (el, ctx) => {
          return (skipPrepare ? Promise.resolve() : prepare(el, ctx)).catch(() => {}) // recover from failed `prepare`
          .then(() => {
            if (render) {
              return render(el, ctx);
            }

            if (false) {
              return serverRender(el, logger);
            } else {
              return clientRender(el);
            }
          });
        };
      },

      middleware({
        criticalChunkIds
      }) {
        return (ctx, next) => {
          if (false && !ctx.element) {
            return next();
          }

          const markAsCritical = false ? chunkId => {
            // Push to legacy context for backwards compat w/ legacy SSR template
            ctx.preloadChunks.push(chunkId); // Also use new service if registered

            if (criticalChunkIds) {
              let chunkIds = criticalChunkIds.from(ctx);
              chunkIds.add(chunkId);
            }
          } : noop; // This is used to collect arbitrary metadata during a given SSR
          // The primary use case is to collect bundler-specific information
          // about import() statements encountered during SSR so that async
          // bundle-split client code can be preloaded/fetched appropriately

          ctx.ssrMetadata = [];
          const pushSSRMetadata = false ? metadata => {
            ctx.ssrMetadata.push(metadata);
          } : noop;
          ctx.element = /*#__PURE__*/_jsx(PrepareProvider, {
            markAsCritical: markAsCritical,
            pushSSRMetadata: pushSSRMetadata,
            children: /*#__PURE__*/_jsx(FusionContext.Provider, {
              value: ctx,
              children: /*#__PURE__*/_jsx(ServiceContext.Provider, {
                value: getService,
                children: ctx.element
              })
            })
          });
          return next();
        };
      }

    });
    super(root, renderer);
  }

}
export { FusionContext, ProviderPlugin, ProvidedHOC, Provider, ServiceConsumer, ServiceContext, useService, withServices };

function noop() {}

export * from './async/index.js';
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJSZWFjdCIsIkZ1c2lvbkFwcCIsImNyZWF0ZVRva2VuIiwiY3JlYXRlUGx1Z2luIiwiQ3JpdGljYWxDaHVua0lkc1Rva2VuIiwicHJlcGFyZSIsIlByZXBhcmVQcm92aWRlciIsIkxvZ2dlclRva2VuIiwiY2xpZW50UmVuZGVyIiwiUHJvdmlkZXJQbHVnaW4iLCJQcm92aWRlZEhPQyIsIlByb3ZpZGVyIiwiRnVzaW9uQ29udGV4dCIsIlNlcnZpY2VDb25zdW1lciIsIlNlcnZpY2VDb250ZXh0IiwidXNlU2VydmljZSIsIndpdGhTZXJ2aWNlcyIsIlNraXBQcmVwYXJlVG9rZW4iLCJBcHAiLCJjb25zdHJ1Y3RvciIsInJvb3QiLCJyZW5kZXIiLCJpc1ZhbGlkRWxlbWVudCIsIkVycm9yIiwiZ2V0U2VydmljZSIsInRva2VuIiwicHJvdmlkZXMiLCJpc1JlcXVpcmVkVG9rZW4iLCJCb29sZWFuIiwib3B0aW9uYWwiLCJuYW1lIiwicmVuZGVyZXIiLCJkZXBzIiwiY3JpdGljYWxDaHVua0lkcyIsInNraXBQcmVwYXJlIiwibG9nZ2VyIiwiZWwiLCJjdHgiLCJQcm9taXNlIiwicmVzb2x2ZSIsImNhdGNoIiwidGhlbiIsInNlcnZlclJlbmRlciIsIm1pZGRsZXdhcmUiLCJuZXh0IiwiZWxlbWVudCIsIm1hcmtBc0NyaXRpY2FsIiwiY2h1bmtJZCIsInByZWxvYWRDaHVua3MiLCJwdXNoIiwiY2h1bmtJZHMiLCJmcm9tIiwiYWRkIiwibm9vcCIsInNzck1ldGFkYXRhIiwicHVzaFNTUk1ldGFkYXRhIiwibWV0YWRhdGEiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0EsT0FBTyxLQUFLQSxLQUFaLE1BQXVCLE9BQXZCO0FBRUEsT0FBT0MsU0FBUCxJQUNFQyxXQURGLEVBRUVDLFlBRkYsRUFHRUMscUJBSEYsUUFLTyxhQUxQO0FBTUEsU0FBUUMsT0FBUixRQUFz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a0IsSUFBakIsQ0FBc0JkLEdBQXRCLENBQWY7QUFDQWEsY0FBQUEsUUFBUSxDQUFDRSxHQUFULENBQWFMLE9BQWI7QUFDRDtBQUNGLFdBVmtCLEdBV25CTSxJQVhKLENBTG9CLENBa0JwQjtBQUNBO0FBQ0E7QUFDQTs7QUFDQWhCLFVBQUFBLEdBQUcsQ0FBQ2lCLFdBQUosR0FBa0IsRUFBbEI7QUFDQSxnQkFBTUMsZUFBZSxHQUFHLFFBQ25CQyxRQUFELElBQWM7QUFDWm5CLFlBQUFBLEdBQUcsQ0FBQ2lCLFdBQUosQ0FBZ0JMLElBQWhCLENBQXFCTyxRQUFyQjtBQUNELFdBSG1CLEdBSXBCSCxJQUpKO0FBTUFoQixVQUFBQSxHQUFHLENBQUNRLE9BQUosZ0JBQ0UsS0FBQyxlQUFEO0FBQ0UsWUFBQSxjQUFjLEVBQUVDLGNBRGxCO0FBRUUsWUFBQSxlQUFlLEVBQUVTLGVBRm5CO0FBQUEsbUNBSUUsS0FBQyxhQUFELENBQWUsUUFBZjtBQUF3QixjQUFBLEtBQUssRUFBRWxCLEdBQS9CO0FBQUEscUNBQ0UsS0FBQyxjQUFELENBQWdCLFFBQWhCO0FBQXlCLGdCQUFBLEtBQUssRUFBRWIsVUFBaEM7QUFBQSwwQkFDR2EsR0FBRyxDQUFDUTtBQURQO0FBREY7QUFKRixZQURGO0FBWUEsaUJBQU9ELElBQUksRUFBWDtBQUNELFNBMUNEO0FBMkNEOztBQWxFMkIsS0FBRCxDQUE3QjtBQW9FQSxVQUFNeEIsSUFBTixFQUFZVyxRQUFaO0FBQ0Q7O0FBdkZ3QztBQTBGM0MsU0FDRW5CLGFBREYsRUFFRUgsY0FGRixFQUdFQyxXQUhGLEVBSUVDLFFBSkYsRUFLRUUsZUFMRixFQU1FQyxjQU5GLEVBT0VDLFVBUEYsRUFRRUMsWUFSRjs7QUFXQSxTQUFTcUMsSUFBVCxHQUFnQixDQUFFOztBQUVsQixjQUFjLGtCQUFkIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKi9cblxuLyogZXNsaW50LWVudiBicm93c2VyICovXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBGdXNpb25BcHAsIHtcbiAgY3JlYXRlVG9rZW4sXG4gIGNyZWF0ZVBsdWdpbixcbiAgQ3JpdGljYWxDaHVua0lkc1Rva2VuLFxuICB0eXBlIENvbnRleHQsXG59IGZyb20gJ2Z1c2lvbi1jb3JlJztcbmltcG9ydCB7cHJlcGFyZX0gZnJvbSAnLi9hc3luYy9pbmRleC5qcyc7XG5pbXBvcnQgUHJlcGFyZVByb3ZpZGVyIGZyb20gJy4vYXN5bmMvcHJlcGFyZS1wcm92aWRlcic7XG5pbXBvcnQge0xvZ2dlclRva2VufSBmcm9tICdmdXNpb24tdG9rZW5zJztcblxuaW1wb3J0IHNlcnZlclJlbmRlciBmcm9tICcuL3NlcnZlcic7XG5pbXBvcnQgY2xpZW50UmVuZGVyIGZyb20gJy4vY2xpZW50JztcblxuaW1wb3J0IFByb3ZpZGVyUGx1Z2luIGZyb20gJy4vcGx1Z2luJztcbmltcG9ydCBQcm92aWRlZEhPQyBmcm9tICcuL2hvYyc7XG5pbXBvcnQgUHJvdmlkZXIgZnJvbSAnLi9wcm92aWRlcic7XG5cbmltcG9ydCB7XG4gIEZ1c2lvbkNvbnRleHQsXG4gIFNlcnZpY2VDb25zdW1lcixcbiAgU2VydmljZUNvbnRleHQsXG4gIHVzZVNlcnZpY2UsXG4gIHdpdGhTZXJ2aWNlcyxcbn0gZnJvbSAnLi9jb250ZXh0LmpzJztcblxuZXhwb3J0IGNvbnN0IFNraXBQcmVwYXJlVG9rZW4gPSBjcmVhdGVUb2tlbjxib29sZWFuPignU2tpcFByZXBhcmVUb2tlbicpO1xuXG5leHBvcnQgdHlwZSBSZW5kZXIgPSAoZWw6IFJlYWN0LkVsZW1lbnQ8Kj4sIGNvbnRleHQ6IENvbnRleHQpID0+IGFueTtcblxuZGVjbGFyZSB2YXIgX19OT0RFX186IEJvb2xlYW47XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcCBleHRlbmRzIEZ1c2lvbkFwcCB7XG4gIGNvbnN0cnVjdG9yKHJvb3Q6IFJlYWN0LkVsZW1lbnQ8Kj4sIHJlbmRlcjogP1JlbmRlcikge1xuICAgIGlmICghUmVhY3QuaXNWYWxpZEVsZW1lbnQocm9vdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0ludmFsaWQgUmVhY3QgZWxlbWVudC4gRW5zdXJlIHlvdXIgcm9vdCBlbGVtZW50IGlzIGEgUmVhY3QuRWxlbWVudCAoZS5nLiA8Rm9vIC8+KSBhbmQgbm90IGEgUmVhY3QuQ29tcG9uZW50IChlLmcuIEZvbyknXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCBnZXRTZXJ2aWNlID0gKHRva2VuKSA9PiB7XG4gICAgICAvLyAkRmxvd0ZpeE1lXG4gICAgICBjb25zdCBwcm92aWRlcyA9IHRoaXMuZ2V0U2VydmljZSh0b2tlbik7XG4gICAgICBjb25zdCBpc1JlcXVpcmVkVG9rZW4gPSBCb29sZWFuKHRva2VuLm9wdGlvbmFsKTtcbiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZXMgPT09ICd1bmRlZmluZWQnICYmIGlzUmVxdWlyZWRUb2tlbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFRva2VuICR7dG9rZW4ubmFtZX0gbm90IHJlZ2lzdGVyZWQgb3IgcmVnaXN0ZXJlZCBwbHVnaW4gZG9lcyBub3QgcHJvdmlkZSBhIHNlcnZpY2UuIFRvIHVzZSBhbiBvcHRpb25hbCBwbHVnaW4sIHVzZSBcXGBUb2tlbi5vcHRpb25hbFxcYC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcHJvdmlkZXM7XG4gICAgfTtcbiAgICBjb25zdCByZW5kZXJlciA9IGNyZWF0ZVBsdWdpbih7XG4gICAgICBkZXBzOiB7XG4gICAgICAgIGNyaXRpY2FsQ2h1bmtJZHM6IENyaXRpY2FsQ2h1bmtJZHNUb2tlbi5vcHRpb25hbCxcbiAgICAgICAgc2tpcFByZXBhcmU6IFNraXBQcmVwYXJlVG9rZW4ub3B0aW9uYWwsXG4gICAgICAgIGxvZ2dlcjogTG9nZ2VyVG9rZW4ub3B0aW9uYWwsXG4gICAgICB9LFxuICAgICAgcHJvdmlkZXMoe3NraXBQcmVwYXJlLCBsb2dnZXJ9KSB7XG4gICAgICAgIHJldHVybiAoZWw6IFJlYWN0LkVsZW1lbnQ8Kj4sIGN0eCkgPT4ge1xuICAgICAgICAgIHJldHVybiAoc2tpcFByZXBhcmUgPyBQcm9taXNlLnJlc29sdmUoKSA6IHByZXBhcmUoZWwsIGN0eCkpXG4gICAgICAgICAgICAuY2F0Y2goKCkgPT4ge30pIC8vIHJlY292ZXIgZnJvbSBmYWlsZWQgYHByZXBhcmVgXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZW5kZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVuZGVyKGVsLCBjdHgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChfX05PREVfXykge1xuICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2ZXJSZW5kZXIoZWwsIGxvZ2dlcik7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsaWVudFJlbmRlcihlbCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIG1pZGRsZXdhcmUoe2NyaXRpY2FsQ2h1bmtJZHN9KSB7XG4gICAgICAgIHJldHVybiAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgaWYgKF9fTk9ERV9fICYmICFjdHguZWxlbWVudCkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBtYXJrQXNDcml0aWNhbCA9IF9fTk9ERV9fXG4gICAgICAgICAgICA/IChjaHVua0lkKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gUHVzaCB0byBsZWdhY3kgY29udGV4dCBmb3IgYmFja3dhcmRzIGNvbXBhdCB3LyBsZWdhY3kgU1NSIHRlbXBsYXRlXG4gICAgICAgICAgICAgICAgY3R4LnByZWxvYWRDaHVua3MucHVzaChjaHVua0lkKTtcblxuICAgICAgICAgICAgICAgIC8vIEFsc28gdXNlIG5ldyBzZXJ2aWNlIGlmIHJlZ2lzdGVyZWRcbiAgICAgICAgICAgICAgICBpZiAoY3JpdGljYWxDaHVua0lkcykge1xuICAgICAgICAgICAgICAgICAgbGV0IGNodW5rSWRzID0gY3JpdGljYWxDaHVua0lkcy5mcm9tKGN0eCk7XG4gICAgICAgICAgICAgICAgICBjaHVua0lkcy5hZGQoY2h1bmtJZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICA6IG5vb3A7XG5cbiAgICAgICAgICAvLyBUaGlzIGlzIHVzZWQgdG8gY29sbGVjdCBhcmJpdHJhcnkgbWV0YWRhdGEgZHVyaW5nIGEgZ2l2ZW4gU1NSXG4gICAgICAgICAgLy8gVGhlIHByaW1hcnkgdXNlIGNhc2UgaXMgdG8gY29sbGVjdCBidW5kbGVyLXNwZWNpZmljIGluZm9ybWF0aW9uXG4gICAgICAgICAgLy8gYWJvdXQgaW1wb3J0KCkgc3RhdGVtZW50cyBlbmNvdW50ZXJlZCBkdXJpbmcgU1NSIHNvIHRoYXQgYXN5bmNcbiAgICAgICAgICAvLyBidW5kbGUtc3BsaXQgY2xpZW50IGNvZGUgY2FuIGJlIHByZWxvYWRlZC9mZXRjaGVkIGFwcHJvcHJpYXRlbHlcbiAgICAgICAgICBjdHguc3NyTWV0YWRhdGEgPSBbXTtcbiAgICAgICAgICBjb25zdCBwdXNoU1NSTWV0YWRhdGEgPSBfX05PREVfX1xuICAgICAgICAgICAgPyAobWV0YWRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBjdHguc3NyTWV0YWRhdGEucHVzaChtZXRhZGF0YSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIDogbm9vcDtcblxuICAgICAgICAgIGN0eC5lbGVtZW50ID0gKFxuICAgICAgICAgICAgPFByZXBhcmVQcm92aWRlclxuICAgICAgICAgICAgICBtYXJrQXNDcml0aWNhbD17bWFya0FzQ3JpdGljYWx9XG4gICAgICAgICAgICAgIHB1c2hTU1JNZXRhZGF0YT17cHVzaFNTUk1ldGFkYXRhfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICA8RnVzaW9uQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17Y3R4fT5cbiAgICAgICAgICAgICAgICA8U2VydmljZUNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2dldFNlcnZpY2V9PlxuICAgICAgICAgICAgICAgICAge2N0eC5lbGVtZW50fVxuICAgICAgICAgICAgICAgIDwvU2VydmljZUNvbnRleHQuUHJvdmlkZXI+XG4gICAgICAgICAgICAgIDwvRnVzaW9uQ29udGV4dC5Qcm92aWRlcj5cbiAgICAgICAgICAgIDwvUHJlcGFyZVByb3ZpZGVyPlxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgc3VwZXIocm9vdCwgcmVuZGVyZXIpO1xuICB9XG59XG5cbmV4cG9ydCB7XG4gIEZ1c2lvbkNvbnRleHQsXG4gIFByb3ZpZGVyUGx1Z2luLFxuICBQcm92aWRlZEhPQyxcbiAgUHJvdmlkZXIsXG4gIFNlcnZpY2VDb25zdW1lcixcbiAgU2VydmljZUNvbnRleHQsXG4gIHVzZVNlcnZpY2UsXG4gIHdpdGhTZXJ2aWNlcyxcbn07XG5cbmZ1bmN0aW9uIG5vb3AoKSB7fVxuXG5leHBvcnQgKiBmcm9tICcuL2FzeW5jL2luZGV4LmpzJztcbiJdfQ==