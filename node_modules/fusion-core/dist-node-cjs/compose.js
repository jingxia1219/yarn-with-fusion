"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.compose = compose;

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
// inline version of koa-compose to get around Rollup/CUP commonjs-related issue
function compose(middleware) {
  if (!Array.isArray(middleware)) {
    throw new TypeError('Middleware stack must be an array!');
  }

  for (const fn of middleware) {
    if (typeof fn !== 'function') {
      throw new TypeError(`Expected middleware function, received: ${typeof fn}`);
    }
  }

  return function (context, next) {
    let index = -1;
    return dispatch(0);

    function dispatch(i) {
      if (i <= index) {
        return Promise.reject(new Error('next() called multiple times'));
      }

      index = i;
      let fn = middleware[i];
      if (i === middleware.length) fn = next;
      if (!fn) return Promise.resolve();

      try {
        return fn(context, function next() {
          return dispatch(i + 1);
        });
      } catch (err) {
        return Promise.reject(err);
      }
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9jb21wb3NlLmpzIl0sIm5hbWVzIjpbImNvbXBvc2UiLCJtaWRkbGV3YXJlIiwiQXJyYXkiLCJpc0FycmF5IiwiVHlwZUVycm9yIiwiZm4iLCJjb250ZXh0IiwibmV4dCIsImluZGV4IiwiZGlzcGF0Y2giLCJpIiwiUHJvbWlzZSIsInJlamVjdCIsIkVycm9yIiwibGVuZ3RoIiwicmVzb2x2ZSIsImVyciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUE7QUFDTyxTQUFTQSxPQUFULENBQWlCQyxVQUFqQixFQUE2QjtBQUNsQyxNQUFJLENBQUNDLEtBQUssQ0FBQ0MsT0FBTixDQUFjRixVQUFkLENBQUwsRUFBZ0M7QUFDOUIsVUFBTSxJQUFJRyxTQUFKLENBQWMsb0NBQWQsQ0FBTjtBQUNEOztBQUNELE9BQUssTUFBTUMsRUFBWCxJQUFpQkosVUFBakIsRUFBNkI7QUFDM0IsUUFBSSxPQUFPSSxFQUFQLEtBQWMsVUFBbEIsRUFBOEI7QUFDNUIsWUFBTSxJQUFJRCxTQUFKLENBQ0gsMkNBQTBDLE9BQU9DLEVBQUcsRUFEakQsQ0FBTjtBQUdEO0FBQ0Y7O0FBRUQsU0FBTyxVQUFVQyxPQUFWLEVBQW1CQyxJQUFuQixFQUF5QjtBQUM5QixRQUFJQyxLQUFLLEdBQUcsQ0FBQyxDQUFiO0FBQ0EsV0FBT0MsUUFBUSxDQUFDLENBQUQsQ0FBZjs7QUFDQSxhQUFTQSxRQUFULENBQWtCQyxDQUFsQixFQUFxQjtBQUNuQixVQUFJQSxDQUFDLElBQUlGLEtBQVQsRUFBZ0I7QUFDZCxlQUFPRyxPQUFPLENBQUNDLE1BQVIsQ0FBZSxJQUFJQyxLQUFKLENBQVUsOEJBQVYsQ0FBZixDQUFQO0FBQ0Q7O0FBQ0RMLE1BQUFBLEtBQUssR0FBR0UsQ0FBUjtBQUNBLFVBQUlMLEVBQUUsR0FBR0osVUFBVSxDQUFDUyxDQUFELENBQW5CO0FBQ0EsVUFBSUEsQ0FBQyxLQUFLVCxVQUFVLENBQUNhLE1BQXJCLEVBQTZCVCxFQUFFLEdBQUdFLElBQUw7QUFDN0IsVUFBSSxDQUFDRixFQUFMLEVBQVMsT0FBT00sT0FBTyxDQUFDSSxPQUFSLEVBQVA7O0FBQ1QsVUFBSTtBQUNGLGVBQU9WLEVBQUUsQ0FBQ0MsT0FBRCxFQUFVLFNBQVNDLElBQVQsR0FBZ0I7QUFDakMsaUJBQU9FLFFBQVEsQ0FBQ0MsQ0FBQyxHQUFHLENBQUwsQ0FBZjtBQUNELFNBRlEsQ0FBVDtBQUdELE9BSkQsQ0FJRSxPQUFPTSxHQUFQLEVBQVk7QUFDWixlQUFPTCxPQUFPLENBQUNDLE1BQVIsQ0FBZUksR0FBZixDQUFQO0FBQ0Q7QUFDRjtBQUNGLEdBbkJEO0FBb0JEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBub2Zsb3dcbiAqL1xuXG4vLyBpbmxpbmUgdmVyc2lvbiBvZiBrb2EtY29tcG9zZSB0byBnZXQgYXJvdW5kIFJvbGx1cC9DVVAgY29tbW9uanMtcmVsYXRlZCBpc3N1ZVxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2UobWlkZGxld2FyZSkge1xuICBpZiAoIUFycmF5LmlzQXJyYXkobWlkZGxld2FyZSkpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdNaWRkbGV3YXJlIHN0YWNrIG11c3QgYmUgYW4gYXJyYXkhJyk7XG4gIH1cbiAgZm9yIChjb25zdCBmbiBvZiBtaWRkbGV3YXJlKSB7XG4gICAgaWYgKHR5cGVvZiBmbiAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcbiAgICAgICAgYEV4cGVjdGVkIG1pZGRsZXdhcmUgZnVuY3Rpb24sIHJlY2VpdmVkOiAke3R5cGVvZiBmbn1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBmdW5jdGlvbiAoY29udGV4dCwgbmV4dCkge1xuICAgIGxldCBpbmRleCA9IC0xO1xuICAgIHJldHVybiBkaXNwYXRjaCgwKTtcbiAgICBmdW5jdGlvbiBkaXNwYXRjaChpKSB7XG4gICAgICBpZiAoaSA8PSBpbmRleCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCduZXh0KCkgY2FsbGVkIG11bHRpcGxlIHRpbWVzJykpO1xuICAgICAgfVxuICAgICAgaW5kZXggPSBpO1xuICAgICAgbGV0IGZuID0gbWlkZGxld2FyZVtpXTtcbiAgICAgIGlmIChpID09PSBtaWRkbGV3YXJlLmxlbmd0aCkgZm4gPSBuZXh0O1xuICAgICAgaWYgKCFmbikgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGZuKGNvbnRleHQsIGZ1bmN0aW9uIG5leHQoKSB7XG4gICAgICAgICAgcmV0dXJuIGRpc3BhdGNoKGkgKyAxKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgfVxuICB9O1xufVxuIl19