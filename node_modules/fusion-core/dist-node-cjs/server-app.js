"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _compose = require("./compose.js");

var _timing = _interopRequireWildcard(require("./plugins/timing"));

var _baseApp = _interopRequireDefault(require("./base-app"));

var _serverRenderer = _interopRequireDefault(require("./plugins/server-renderer"));

var _tokens = require("./tokens");

var _ssr = _interopRequireDefault(require("./plugins/ssr"));

var _serverContext = _interopRequireDefault(require("./plugins/server-context.js"));

var _appSymbol = require("./utils/app-symbol.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */

/* eslint-env node */
function _default() {
  const Koa = require('koa');

  return class ServerApp extends _baseApp.default {
    constructor(el, render) {
      super(el, render);
      this.endpoints = new Map();
      this._app = new Koa();
      this._app.proxy = true;
      this.middleware(_serverContext.default);
      this.middleware((ctx, next) => {
        ctx[_appSymbol.appSymbol] = this;
        return next();
      });
      this.register(_timing.TimingToken, _timing.default);
      this.middleware((ctx, next) => {
        for (const [endpointPath, handler] of this.endpoints) {
          if (ctx.path === endpointPath) {
            return handler(ctx, next);
          }
        }

        return next();
      });
      this.middleware({
        element: _tokens.ElementToken,
        ssrDecider: _tokens.SSRDeciderToken,
        ssrBodyTemplate: _tokens.SSRBodyTemplateToken.optional
      }, (0, _ssr.default)(this.endpoints));
    }

    resolve() {
      this.middleware({
        timing: _timing.TimingToken,
        render: _tokens.RenderToken
      }, (0, _serverRenderer.default)(this));
      return super.resolve();
    }

    callback() {
      this.resolve();

      this._app.use((0, _compose.compose)(this.plugins));

      return this._app.callback();
    }

  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zZXJ2ZXItYXBwLmpzIl0sIm5hbWVzIjpbIktvYSIsInJlcXVpcmUiLCJTZXJ2ZXJBcHAiLCJCYXNlQXBwIiwiY29uc3RydWN0b3IiLCJlbCIsInJlbmRlciIsImVuZHBvaW50cyIsIk1hcCIsIl9hcHAiLCJwcm94eSIsIm1pZGRsZXdhcmUiLCJjb250ZXh0TWlkZGxld2FyZSIsImN0eCIsIm5leHQiLCJhcHBTeW1ib2wiLCJyZWdpc3RlciIsIlRpbWluZ1Rva2VuIiwiVGltaW5nIiwiZW5kcG9pbnRQYXRoIiwiaGFuZGxlciIsInBhdGgiLCJlbGVtZW50IiwiRWxlbWVudFRva2VuIiwic3NyRGVjaWRlciIsIlNTUkRlY2lkZXJUb2tlbiIsInNzckJvZHlUZW1wbGF0ZSIsIlNTUkJvZHlUZW1wbGF0ZVRva2VuIiwib3B0aW9uYWwiLCJyZXNvbHZlIiwidGltaW5nIiwiUmVuZGVyVG9rZW4iLCJjYWxsYmFjayIsInVzZSIsInBsdWdpbnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFRQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFNQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFwQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBQ0E7QUFlZSxvQkFBWTtBQUN6QixRQUFNQSxHQUFHLEdBQUdDLE9BQU8sQ0FBQyxLQUFELENBQW5COztBQUVBLFNBQU8sTUFBTUMsU0FBTixTQUF3QkMsZ0JBQXhCLENBQWdDO0FBQ3JDQyxJQUFBQSxXQUFXLENBQUNDLEVBQUQsRUFBS0MsTUFBTCxFQUFhO0FBQ3RCLFlBQU1ELEVBQU4sRUFBVUMsTUFBVjtBQUNBLFdBQUtDLFNBQUwsR0FBaUIsSUFBSUMsR0FBSixFQUFqQjtBQUNBLFdBQUtDLElBQUwsR0FBWSxJQUFJVCxHQUFKLEVBQVo7QUFDQSxXQUFLUyxJQUFMLENBQVVDLEtBQVYsR0FBa0IsSUFBbEI7QUFDQSxXQUFLQyxVQUFMLENBQWdCQyxzQkFBaEI7QUFDQSxXQUFLRCxVQUFMLENBQWdCLENBQUNFLEdBQUQsRUFBTUMsSUFBTixLQUFlO0FBQzdCRCxRQUFBQSxHQUFHLENBQUNFLG9CQUFELENBQUgsR0FBaUIsSUFBakI7QUFDQSxlQUFPRCxJQUFJLEVBQVg7QUFDRCxPQUhEO0FBSUEsV0FBS0UsUUFBTCxDQUFjQyxtQkFBZCxFQUEyQkMsZUFBM0I7QUFDQSxXQUFLUCxVQUFMLENBQWdCLENBQUNFLEdBQUQsRUFBTUMsSUFBTixLQUFlO0FBQzdCLGFBQUssTUFBTSxDQUFDSyxZQUFELEVBQWVDLE9BQWYsQ0FBWCxJQUFzQyxLQUFLYixTQUEzQyxFQUFzRDtBQUNwRCxjQUFJTSxHQUFHLENBQUNRLElBQUosS0FBYUYsWUFBakIsRUFBK0I7QUFDN0IsbUJBQU9DLE9BQU8sQ0FBQ1AsR0FBRCxFQUFNQyxJQUFOLENBQWQ7QUFDRDtBQUNGOztBQUNELGVBQU9BLElBQUksRUFBWDtBQUNELE9BUEQ7QUFRQSxXQUFLSCxVQUFMLENBQ0U7QUFDRVcsUUFBQUEsT0FBTyxFQUFFQyxvQkFEWDtBQUVFQyxRQUFBQSxVQUFVLEVBQUVDLHVCQUZkO0FBR0VDLFFBQUFBLGVBQWUsRUFBRUMsNkJBQXFCQztBQUh4QyxPQURGLEVBTUUsa0JBQVUsS0FBS3JCLFNBQWYsQ0FORjtBQVFEOztBQUNEc0IsSUFBQUEsT0FBTyxHQUFHO0FBQ1IsV0FBS2xCLFVBQUwsQ0FDRTtBQUFDbUIsUUFBQUEsTUFBTSxFQUFFYixtQkFBVDtBQUFzQlgsUUFBQUEsTUFBTSxFQUFFeUI7QUFBOUIsT0FERixFQUVFLDZCQUFlLElBQWYsQ0FGRjtBQUlBLGFBQU8sTUFBTUYsT0FBTixFQUFQO0FBQ0Q7O0FBQ0RHLElBQUFBLFFBQVEsR0FBRztBQUNULFdBQUtILE9BQUw7O0FBQ0EsV0FBS3BCLElBQUwsQ0FBVXdCLEdBQVYsQ0FBYyxzQkFBUSxLQUFLQyxPQUFiLENBQWQ7O0FBQ0EsYUFBTyxLQUFLekIsSUFBTCxDQUFVdUIsUUFBVixFQUFQO0FBQ0Q7O0FBeENvQyxHQUF2QztBQTBDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBDb3B5cmlnaHQgKGMpIDIwMTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAbm9mbG93XG4gKi9cbi8qIGVzbGludC1lbnYgbm9kZSAqL1xuaW1wb3J0IHtjb21wb3NlfSBmcm9tICcuL2NvbXBvc2UuanMnO1xuaW1wb3J0IFRpbWluZywge1RpbWluZ1Rva2VufSBmcm9tICcuL3BsdWdpbnMvdGltaW5nJztcbmltcG9ydCBCYXNlQXBwIGZyb20gJy4vYmFzZS1hcHAnO1xuaW1wb3J0IHNlcnZlclJlbmRlcmVyIGZyb20gJy4vcGx1Z2lucy9zZXJ2ZXItcmVuZGVyZXInO1xuaW1wb3J0IHtcbiAgUmVuZGVyVG9rZW4sXG4gIEVsZW1lbnRUb2tlbixcbiAgU1NSRGVjaWRlclRva2VuLFxuICBTU1JCb2R5VGVtcGxhdGVUb2tlbixcbn0gZnJvbSAnLi90b2tlbnMnO1xuaW1wb3J0IHNzclBsdWdpbiBmcm9tICcuL3BsdWdpbnMvc3NyJztcbmltcG9ydCBjb250ZXh0TWlkZGxld2FyZSBmcm9tICcuL3BsdWdpbnMvc2VydmVyLWNvbnRleHQuanMnO1xuaW1wb3J0IHthcHBTeW1ib2x9IGZyb20gJy4vdXRpbHMvYXBwLXN5bWJvbC5qcyc7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uICgpIHtcbiAgY29uc3QgS29hID0gcmVxdWlyZSgna29hJyk7XG5cbiAgcmV0dXJuIGNsYXNzIFNlcnZlckFwcCBleHRlbmRzIEJhc2VBcHAge1xuICAgIGNvbnN0cnVjdG9yKGVsLCByZW5kZXIpIHtcbiAgICAgIHN1cGVyKGVsLCByZW5kZXIpO1xuICAgICAgdGhpcy5lbmRwb2ludHMgPSBuZXcgTWFwKCk7XG4gICAgICB0aGlzLl9hcHAgPSBuZXcgS29hKCk7XG4gICAgICB0aGlzLl9hcHAucHJveHkgPSB0cnVlO1xuICAgICAgdGhpcy5taWRkbGV3YXJlKGNvbnRleHRNaWRkbGV3YXJlKTtcbiAgICAgIHRoaXMubWlkZGxld2FyZSgoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgIGN0eFthcHBTeW1ib2xdID0gdGhpcztcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5yZWdpc3RlcihUaW1pbmdUb2tlbiwgVGltaW5nKTtcbiAgICAgIHRoaXMubWlkZGxld2FyZSgoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgIGZvciAoY29uc3QgW2VuZHBvaW50UGF0aCwgaGFuZGxlcl0gb2YgdGhpcy5lbmRwb2ludHMpIHtcbiAgICAgICAgICBpZiAoY3R4LnBhdGggPT09IGVuZHBvaW50UGF0aCkge1xuICAgICAgICAgICAgcmV0dXJuIGhhbmRsZXIoY3R4LCBuZXh0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5taWRkbGV3YXJlKFxuICAgICAgICB7XG4gICAgICAgICAgZWxlbWVudDogRWxlbWVudFRva2VuLFxuICAgICAgICAgIHNzckRlY2lkZXI6IFNTUkRlY2lkZXJUb2tlbixcbiAgICAgICAgICBzc3JCb2R5VGVtcGxhdGU6IFNTUkJvZHlUZW1wbGF0ZVRva2VuLm9wdGlvbmFsLFxuICAgICAgICB9LFxuICAgICAgICBzc3JQbHVnaW4odGhpcy5lbmRwb2ludHMpXG4gICAgICApO1xuICAgIH1cbiAgICByZXNvbHZlKCkge1xuICAgICAgdGhpcy5taWRkbGV3YXJlKFxuICAgICAgICB7dGltaW5nOiBUaW1pbmdUb2tlbiwgcmVuZGVyOiBSZW5kZXJUb2tlbn0sXG4gICAgICAgIHNlcnZlclJlbmRlcmVyKHRoaXMpXG4gICAgICApO1xuICAgICAgcmV0dXJuIHN1cGVyLnJlc29sdmUoKTtcbiAgICB9XG4gICAgY2FsbGJhY2soKSB7XG4gICAgICB0aGlzLnJlc29sdmUoKTtcbiAgICAgIHRoaXMuX2FwcC51c2UoY29tcG9zZSh0aGlzLnBsdWdpbnMpKTtcbiAgICAgIHJldHVybiB0aGlzLl9hcHAuY2FsbGJhY2soKTtcbiAgICB9XG4gIH07XG59XG4iXX0=