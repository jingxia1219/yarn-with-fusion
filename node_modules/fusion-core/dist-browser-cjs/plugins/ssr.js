"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createSSRPlugin;
exports.SSRDecider = void 0;

var _createPlugin = require("../create-plugin");

var _sanitization = require("../sanitization");

var _appSymbol = require("../utils/app-symbol.js");

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
const botRegex = /(bot|crawler|spider)/i;
const SSRDecider = (0, _createPlugin.createPlugin)({
  provides: () => {
    return ctx => {
      // If the request has one of these extensions, we assume it's not something that requires server-side rendering of virtual dom
      // TODO(#46): this check should probably look at the asset manifest to ensure asset 404s are handled correctly
      if (ctx.path.match(/\.(js|js\.map|gif|jpg|png|pdf|json|svg)$/)) return false; // Bots don't always include the accept header.

      if (ctx.headers['user-agent']) {
        const agent = ctx.headers['user-agent'];

        if (botRegex.test(agent) && ctx.method === 'GET') {
          return true;
        }
      } // The Accept header is a good proxy for whether SSR should happen
      // Requesting an HTML page via the browser url bar generates a request with `text/html` in its Accept headers
      // XHR/fetch requests do not have `text/html` in the Accept headers


      if (!ctx.headers.accept) return false;
      if (!ctx.headers.accept.includes('text/html')) return false;
      return true;
    };
  }
});
exports.SSRDecider = SSRDecider;

function createSSRPlugin(endpoints) {
  return function ssrMiddleware({
    element,
    ssrDecider,
    ssrBodyTemplate
  }) {
    return async function ssrMiddleware(ctx, next) {
      if (endpoints.has(ctx.path)) {
        return next();
      }

      if (!ssrDecider(ctx)) return next();
      const template = {
        htmlAttrs: {},
        bodyAttrs: {},
        title: '',
        head: [],
        body: []
      };
      ctx.element = element;
      ctx.rendered = '';
      ctx.template = template;
      ctx.type = 'text/html';
      await next(); // Allow someone to override the ssr by setting ctx.body
      // This is especially useful for things like ctx.redirect

      if (ctx.body && ctx.respond !== false) {
        return;
      }

      ctx.template.head.push(getSerializedUniversalValues(ctx));

      if (ssrBodyTemplate) {
        ctx.body = ssrBodyTemplate(ctx);
      } else {
        ctx.body = legacySSRBodyTemplate(ctx);
      }
    };
  };
}

function legacySSRBodyTemplate(ctx) {
  const {
    htmlAttrs,
    bodyAttrs,
    title,
    head,
    body
  } = ctx.template;
  const safeAttrs = Object.keys(htmlAttrs).map(attrKey => {
    return ` ${(0, _sanitization.escape)(attrKey)}="${(0, _sanitization.escape)(htmlAttrs[attrKey])}"`;
  }).join('');
  const safeBodyAttrs = Object.keys(bodyAttrs).map(attrKey => {
    return ` ${(0, _sanitization.escape)(attrKey)}="${(0, _sanitization.escape)(bodyAttrs[attrKey])}"`;
  }).join('');
  const safeTitle = (0, _sanitization.escape)(title);
  const safeHead = head.map(_sanitization.consumeSanitizedHTML).join('');
  const safeBody = body.map(_sanitization.consumeSanitizedHTML).join('');
  const preloadHintLinks = getPreloadHintLinks(ctx);
  const coreGlobals = getCoreGlobals(ctx);
  const chunkScripts = getChunkScripts(ctx);
  const bundleSplittingBootstrap = [preloadHintLinks, coreGlobals, chunkScripts].join('');
  return ['<!doctype html>', `<html${safeAttrs}>`, `<head>`, `<meta charset="utf-8" />`, `<title>${safeTitle}</title>`, `${bundleSplittingBootstrap}${safeHead}`, `</head>`, `<body${safeBodyAttrs}>${ctx.rendered}${safeBody}</body>`, '</html>'].join('');
}

function getCoreGlobals(ctx) {
  const {
    webpackPublicPath,
    nonce
  } = ctx;
  return [`<script nonce="${nonce}">`, `window.performance && window.performance.mark && window.performance.mark('firstRenderStart');`, `__ROUTE_PREFIX__ = ${JSON.stringify(ctx.prefix)};`, // consumed by ./client
  `__WEBPACK_PUBLIC_PATH__ = ${JSON.stringify(webpackPublicPath)};`, // consumed by fusion-clientries/client-entry
  `</script>`].join('');
}

function getUrls({
  chunkUrlMap,
  webpackPublicPath
}, chunks) {
  // cross origin is needed to get meaningful errors in window.onerror
  const isCrossOrigin = webpackPublicPath.startsWith('http');
  const crossOriginAttribute = isCrossOrigin ? ' crossorigin="anonymous"' : '';
  return [...new Set(chunks)].map(id => {
    let url = chunkUrlMap.get(id).get('es5');

    if (webpackPublicPath.endsWith('/')) {
      url = webpackPublicPath + url;
    } else {
      url = webpackPublicPath + '/' + url;
    }

    return {
      url,
      crossOriginAttribute
    };
  });
}

function getChunkScripts(ctx) {
  const sync = getUrls(ctx, ctx.syncChunks).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<script nonce="${ctx.nonce}" defer${crossOriginAttribute} src="${url}"></script>`;
  });
  const preloaded = getUrls(ctx, ctx.preloadChunks.filter(item => !ctx.syncChunks.includes(item))).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<script nonce="${ctx.nonce}" defer${crossOriginAttribute} src="${url}"></script>`;
  });
  return [...preloaded, ...sync].join('');
}

function getPreloadHintLinks(ctx) {
  const chunks = [...ctx.preloadChunks, ...ctx.syncChunks];
  const hints = getUrls(ctx, chunks).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<link rel="preload"${crossOriginAttribute} href="${url}" nonce="${ctx.nonce}" as="script" />`;
  });
  return hints.join('');
}

function getSerializedUniversalValues(ctx) {
  const app = ctx[_appSymbol.appSymbol];
  return (0, _sanitization.html)`<script type="application/json" id="__FUSION_UNIVERSAL_VALUES__">
    ${JSON.stringify({ ...app.universalValues,
    ...ctx.universalValues
  })}
  </script>`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9wbHVnaW5zL3Nzci5qcyJdLCJuYW1lcyI6WyJib3RSZWdleCIsIlNTUkRlY2lkZXIiLCJwcm92aWRlcyIsImN0eCIsInBhdGgiLCJtYXRjaCIsImhlYWRlcnMiLCJhZ2VudCIsInRlc3QiLCJtZXRob2QiLCJhY2NlcHQiLCJpbmNsdWRlcyIsImNyZWF0ZVNTUlBsdWdpbiIsImVuZHBvaW50cyIsInNzck1pZGRsZXdhcmUiLCJlbGVtZW50Iiwic3NyRGVjaWRlciIsInNzckJvZHlUZW1wbGF0ZSIsIm5leHQiLCJoYXMiLCJ0ZW1wbGF0ZSIsImh0bWxBdHRycyIsImJvZHlBdHRycyIsInRpdGxlIiwiaGVhZCIsImJvZHkiLCJyZW5kZXJlZCIsInR5cGUiLCJyZXNwb25kIiwicHVzaCIsImdldFNlcmlhbGl6ZWRVbml2ZXJzYWxWYWx1ZXMiLCJsZWdhY3lTU1JCb2R5VGVtcGxhdGUiLCJzYWZlQXR0cnMiLCJPYmplY3QiLCJrZXlzIiwibWFwIiwiYXR0cktleSIsImpvaW4iLCJzYWZlQm9keUF0dHJzIiwic2FmZVRpdGxlIiwic2FmZUhlYWQiLCJjb25zdW1lU2FuaXRpemVkSFRNTCIsInNhZmVCb2R5IiwicHJlbG9hZEhpbnRMaW5rcyIsImdldFByZWxvYWRIaW50TGlua3MiLCJjb3JlR2xvYmFscyIsImdldENvcmVHbG9iYWxzIiwiY2h1bmtTY3JpcHRzIiwiZ2V0Q2h1bmtTY3JpcHRzIiwiYnVuZGxlU3BsaXR0aW5nQm9vdHN0cmFwIiwid2VicGFja1B1YmxpY1BhdGgiLCJub25jZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJwcmVmaXgiLCJnZXRVcmxzIiwiY2h1bmtVcmxNYXAiLCJjaHVua3MiLCJpc0Nyb3NzT3JpZ2luIiwic3RhcnRzV2l0aCIsImNyb3NzT3JpZ2luQXR0cmlidXRlIiwiU2V0IiwiaWQiLCJ1cmwiLCJnZXQiLCJlbmRzV2l0aCIsInN5bmMiLCJzeW5jQ2h1bmtzIiwicHJlbG9hZGVkIiwicHJlbG9hZENodW5rcyIsImZpbHRlciIs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UUcsR0FBSSxhQUE3RTtBQUNELEdBTGlCLENBQWxCO0FBTUEsU0FBTyxDQUFDLEdBQUdLLFNBQUosRUFBZSxHQUFHRixJQUFsQixFQUF3QjdCLElBQXhCLENBQTZCLEVBQTdCLENBQVA7QUFDRDs7QUFFRCxTQUFTTyxtQkFBVCxDQUE2QnpDLEdBQTdCLEVBQWtDO0FBQ2hDLFFBQU1zRCxNQUFNLEdBQUcsQ0FBQyxHQUFHdEQsR0FBRyxDQUFDa0UsYUFBUixFQUF1QixHQUFHbEUsR0FBRyxDQUFDZ0UsVUFBOUIsQ0FBZjtBQUNBLFFBQU1LLEtBQUssR0FBR2pCLE9BQU8sQ0FBQ3BELEdBQUQsRUFBTXNELE1BQU4sQ0FBUCxDQUFxQnRCLEdBQXJCLENBQXlCLENBQUM7QUFBQzRCLElBQUFBLEdBQUQ7QUFBTUgsSUFBQUE7QUFBTixHQUFELEtBQWlDO0FBQ3RFLFdBQVEsc0JBQXFCQSxvQkFBcUIsVUFBU0csR0FBSSxZQUFXNUQsR0FBRyxDQUFDZ0QsS0FBTSxrQkFBcEY7QUFDRCxHQUZhLENBQWQ7QUFHQSxTQUFPcUIsS0FBSyxDQUFDbkMsSUFBTixDQUFXLEVBQVgsQ0FBUDtBQUNEOztBQUVELFNBQVNQLDRCQUFULENBQXNDM0IsR0FBdEMsRUFBMkM7QUFDekMsUUFBTXNFLEdBQUcsR0FBR3RFLEdBQUcsQ0FBQ3VFLG9CQUFELENBQWY7QUFDQSxTQUFPLHVCQUFLO0FBQ2QsTUFBTXRCLElBQUksQ0FBQ0MsU0FBTCxDQUFlLEVBQUMsR0FBR29CLEdBQUcsQ0FBQ0UsZUFBUjtBQUF5QixPQUFHeEUsR0FBRyxDQUFDd0U7QUFBaEMsR0FBZixDQUFpRTtBQUN2RSxZQUZFO0FBR0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQG5vZmxvd1xuICovXG5cbmltcG9ydCB7Y3JlYXRlUGx1Z2lufSBmcm9tICcuLi9jcmVhdGUtcGx1Z2luJztcbmltcG9ydCB7ZXNjYXBlLCBjb25zdW1lU2FuaXRpemVkSFRNTCwgaHRtbH0gZnJvbSAnLi4vc2FuaXRpemF0aW9uJztcbmltcG9ydCB7YXBwU3ltYm9sfSBmcm9tICcuLi91dGlscy9hcHAtc3ltYm9sLmpzJztcblxuY29uc3QgYm90UmVnZXggPSAvKGJvdHxjcmF3bGVyfHNwaWRlcikvaTtcbmNvbnN0IFNTUkRlY2lkZXIgPSBjcmVhdGVQbHVnaW4oe1xuICBwcm92aWRlczogKCkgPT4ge1xuICAgIHJldHVybiAoY3R4KSA9PiB7XG4gICAgICAvLyBJZiB0aGUgcmVxdWVzdCBoYXMgb25lIG9mIHRoZXNlIGV4dGVuc2lvbnMsIHdlIGFzc3VtZSBpdCdzIG5vdCBzb21ldGhpbmcgdGhhdCByZXF1aXJlcyBzZXJ2ZXItc2lkZSByZW5kZXJpbmcgb2YgdmlydHVhbCBkb21cbiAgICAgIC8vIFRPRE8oIzQ2KTogdGhpcyBjaGVjayBzaG91bGQgcHJvYmFibHkgbG9vayBhdCB0aGUgYXNzZXQgbWFuaWZlc3QgdG8gZW5zdXJlIGFzc2V0IDQwNHMgYXJlIGhhbmRsZWQgY29ycmVjdGx5XG4gICAgICBpZiAoY3R4LnBhdGgubWF0Y2goL1xcLihqc3xqc1xcLm1hcHxnaWZ8anBnfHBuZ3xwZGZ8anNvbnxzdmcpJC8pKVxuICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgIC8vIEJvdHMgZG9uJ3QgYWx3YXlzIGluY2x1ZGUgdGhlIGFjY2VwdCBoZWFkZXIuXG4gICAgICBpZiAoY3R4LmhlYWRlcnNbJ3VzZXItYWdlbnQnXSkge1xuICAgICAgICBjb25zdCBhZ2VudCA9IGN0eC5oZWFkZXJzWyd1c2VyLWFnZW50J107XG4gICAgICAgIGlmIChib3RSZWdleC50ZXN0KGFnZW50KSAmJiBjdHgubWV0aG9kID09PSAnR0VUJykge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFRoZSBBY2NlcHQgaGVhZGVyIGlzIGEgZ29vZCBwcm94eSBmb3Igd2hldGhlciBTU1Igc2hvdWxkIGhhcHBlblxuICAgICAgLy8gUmVxdWVzdGluZyBhbiBIVE1MIHBhZ2UgdmlhIHRoZSBicm93c2VyIHVybCBiYXIgZ2VuZXJhdGVzIGEgcmVxdWVzdCB3aXRoIGB0ZXh0L2h0bWxgIGluIGl0cyBBY2NlcHQgaGVhZGVyc1xuICAgICAgLy8gWEhSL2ZldGNoIHJlcXVlc3RzIGRvIG5vdCBoYXZlIGB0ZXh0L2h0bWxgIGluIHRoZSBBY2NlcHQgaGVhZGVyc1xuICAgICAgaWYgKCFjdHguaGVhZGVycy5hY2NlcHQpIHJldHVybiBmYWxzZTtcbiAgICAgIGlmICghY3R4LmhlYWRlcnMuYWNjZXB0LmluY2x1ZGVzKCd0ZXh0L2h0bWwnKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfTtcbiAgfSxcbn0pO1xuZXhwb3J0IHtTU1JEZWNpZGVyfTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY3JlYXRlU1NSUGx1Z2luKGVuZHBvaW50cykge1xuICByZXR1cm4gZnVuY3Rpb24gc3NyTWlkZGxld2FyZSh7ZWxlbWVudCwgc3NyRGVjaWRlciwgc3NyQm9keVRlbXBsYXRlfSkge1xuICAgIHJldHVybiBhc3luYyBmdW5jdGlvbiBzc3JNaWRkbGV3YXJlKGN0eCwgbmV4dCkge1xuICAgICAgaWYgKGVuZHBvaW50cy5oYXMoY3R4LnBhdGgpKSB7XG4gICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICB9XG4gICAgICBpZiAoIXNzckRlY2lkZXIoY3R4KSkgcmV0dXJuIG5leHQoKTtcblxuICAgICAgY29uc3QgdGVtcGxhdGUgPSB7XG4gICAgICAgIGh0bWxBdHRyczoge30sXG4gICAgICAgIGJvZHlBdHRyczoge30sXG4gICAgICAgIHRpdGxlOiAnJyxcbiAgICAgICAgaGVhZDogW10sXG4gICAgICAgIGJvZHk6IFtdLFxuICAgICAgfTtcbiAgICAgIGN0eC5lbGVtZW50ID0gZWxlbWVudDtcbiAgICAgIGN0eC5yZW5kZXJlZCA9ICcnO1xuICAgICAgY3R4LnRlbXBsYXRlID0gdGVtcGxhdGU7XG4gICAgICBjdHgudHlwZSA9ICd0ZXh0L2h0bWwnO1xuXG4gICAgICBhd2FpdCBuZXh0KCk7XG5cbiAgICAgIC8vIEFsbG93IHNvbWVvbmUgdG8gb3ZlcnJpZGUgdGhlIHNzciBieSBzZXR0aW5nIGN0eC5ib2R5XG4gICAgICAvLyBUaGlzIGlzIGVzcGVjaWFsbHkgdXNlZnVsIGZvciB0aGluZ3MgbGlrZSBjdHgucmVkaXJlY3RcbiAgICAgIGlmIChjdHguYm9keSAmJiBjdHgucmVzcG9uZCAhPT0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjdHgudGVtcGxhdGUuaGVhZC5wdXNoKGdldFNlcmlhbGl6ZWRVbml2ZXJzYWxWYWx1ZXMoY3R4KSk7XG5cbiAgICAgIGlmIChzc3JCb2R5VGVtcGxhdGUpIHtcbiAgICAgICAgY3R4LmJvZHkgPSBzc3JCb2R5VGVtcGxhdGUoY3R4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGN0eC5ib2R5ID0gbGVnYWN5U1NSQm9keVRlbXBsYXRlKGN0eCk7XG4gICAgICB9XG4gICAgfTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gbGVnYWN5U1NSQm9keVRlbXBsYXRlKGN0eCkge1xuICBjb25zdCB7aHRtbEF0dHJzLCBib2R5QXR0cnMsIHRpdGxlLCBoZWFkLCBib2R5fSA9IGN0eC50ZW1wbGF0ZTtcbiAgY29uc3Qgc2FmZUF0dHJzID0gT2JqZWN0LmtleXMoaHRtbEF0dHJzKVxuICAgIC5tYXAoKGF0dHJLZXkpID0+IHtcbiAgICAgIHJldHVybiBgICR7ZXNjYXBlKGF0dHJLZXkpfT1cIiR7ZXNjYXBlKGh0bWxBdHRyc1thdHRyS2V5XSl9XCJgO1xuICAgIH0pXG4gICAgLmpvaW4oJycpO1xuXG4gIGNvbnN0IHNhZmVCb2R5QXR0cnMgPSBPYmplY3Qua2V5cyhib2R5QXR0cnMpXG4gICAgLm1hcCgoYXR0cktleSkgPT4ge1xuICAgICAgcmV0dXJuIGAgJHtlc2NhcGUoYXR0cktleSl9PVwiJHtlc2NhcGUoYm9keUF0dHJzW2F0dHJLZXldKX1cImA7XG4gICAgfSlcbiAgICAuam9pbignJyk7XG5cbiAgY29uc3Qgc2FmZVRpdGxlID0gZXNjYXBlKHRpdGxlKTtcbiAgY29uc3Qgc2FmZUhlYWQgPSBoZWFkLm1hcChjb25zdW1lU2FuaXRpemVkSFRNTCkuam9pbignJyk7XG4gIGNvbnN0IHNhZmVCb2R5ID0gYm9keS5tYXAoY29uc3VtZVNhbml0aXplZEhUTUwpLmpvaW4oJycpO1xuXG4gIGNvbnN0IHByZWxvYWRIaW50TGlua3MgPSBnZXRQcmVsb2FkSGludExpbmtzKGN0eCk7XG4gIGNvbnN0IGNvcmVHbG9iYWxzID0gZ2V0Q29yZUdsb2JhbHMoY3R4KTtcbiAgY29uc3QgY2h1bmtTY3JpcHRzID0gZ2V0Q2h1bmtTY3JpcHRzKGN0eCk7XG4gIGNvbnN0IGJ1bmRsZVNwbGl0dGluZ0Jvb3RzdHJhcCA9IFtcbiAgICBwcmVsb2FkSGludExpbmtzLFxuICAgIGNvcmVHbG9iYWxzLFxuICAgIGNodW5rU2NyaXB0cyxcbiAgXS5qb2luKCcnKTtcblxuICByZXR1cm4gW1xuICAgICc8IWRvY3R5cGUgaHRtbD4nLFxuICAgIGA8aHRtbCR7c2FmZUF0dHJzfT5gLFxuICAgIGA8aGVhZD5gLFxuICAgIGA8bWV0YSBjaGFyc2V0PVwidXRmLThcIiAvPmAsXG4gICAgYDx0aXRsZT4ke3NhZmVUaXRsZX08L3RpdGxlPmAsXG4gICAgYCR7YnVuZGxlU3BsaXR0aW5nQm9vdHN0cmFwfSR7c2FmZUhlYWR9YCxcbiAgICBgPC9oZWFkPmAsXG4gICAgYDxib2R5JHtzYWZlQm9keUF0dHJzfT4ke2N0eC5yZW5kZXJlZH0ke3NhZmVCb2R5fTwvYm9keT5gLFxuICAgICc8L2h0bWw+JyxcbiAgXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0Q29yZUdsb2JhbHMoY3R4KSB7XG4gIGNvbnN0IHt3ZWJwYWNrUHVibGljUGF0aCwgbm9uY2V9ID0gY3R4O1xuXG4gIHJldHVybiBbXG4gICAgYDxzY3JpcHQgbm9uY2U9XCIke25vbmNlfVwiPmAsXG4gICAgYHdpbmRvdy5wZXJmb3JtYW5jZSAmJiB3aW5kb3cucGVyZm9ybWFuY2UubWFyayAmJiB3aW5kb3cucGVyZm9ybWFuY2UubWFyaygnZmlyc3RSZW5kZXJTdGFydCcpO2AsXG4gICAgYF9fUk9VVEVfUFJFRklYX18gPSAke0pTT04uc3RyaW5naWZ5KGN0eC5wcmVmaXgpfTtgLCAvLyBjb25zdW1lZCBieSAuL2NsaWVudFxuICAgIGBfX1dFQlBBQ0tfUFVCTElDX1BBVEhfXyA9ICR7SlNPTi5zdHJpbmdpZnkod2VicGFja1B1YmxpY1BhdGgpfTtgLCAvLyBjb25zdW1lZCBieSBmdXNpb24tY2xpZW50cmllcy9jbGllbnQtZW50cnlcbiAgICBgPC9zY3JpcHQ+YCxcbiAgXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0VXJscyh7Y2h1bmtVcmxNYXAsIHdlYnBhY2tQdWJsaWNQYXRofSwgY2h1bmtzKSB7XG4gIC8vIGNyb3NzIG9yaWdpbiBpcyBuZWVkZWQgdG8gZ2V0IG1lYW5pbmdmdWwgZXJyb3JzIGluIHdpbmRvdy5vbmVycm9yXG4gIGNvbnN0IGlzQ3Jvc3NPcmlnaW4gPSB3ZWJwYWNrUHVibGljUGF0aC5zdGFydHNXaXRoKCdodHRwJyk7XG4gIGNvbnN0IGNyb3NzT3JpZ2luQXR0cmlidXRlID0gaXNDcm9zc09yaWdpbiA/ICcgY3Jvc3NvcmlnaW49XCJhbm9ueW1vdXNcIicgOiAnJztcbiAgcmV0dXJuIFsuLi5uZXcgU2V0KGNodW5rcyldLm1hcCgoaWQpID0+IHtcbiAgICBsZXQgdXJsID0gY2h1bmtVcmxNYXAuZ2V0KGlkKS5nZXQoJ2VzNScpO1xuICAgIGlmICh3ZWJwYWNrUHVibGljUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgICB1cmwgPSB3ZWJwYWNrUHVibGljUGF0aCArIHVybDtcbiAgICB9IGVsc2Uge1xuICAgICAgdXJsID0gd2VicGFja1B1YmxpY1BhdGggKyAnLycgKyB1cmw7XG4gICAgfVxuICAgIHJldHVybiB7dXJsLCBjcm9zc09yaWdpbkF0dHJpYnV0ZX07XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRDaHVua1NjcmlwdHMoY3R4KSB7XG4gIGNvbnN0IHN5bmMgPSBnZXRVcmxzKGN0eCwgY3R4LnN5bmNDaHVua3MpLm1hcChcbiAgICAoe3VybCwgY3Jvc3NPcmlnaW5BdHRyaWJ1dGV9KSA9PiB7XG4gICAgICByZXR1cm4gYDxzY3JpcHQgbm9uY2U9XCIke2N0eC5ub25jZX1cIiBkZWZlciR7Y3Jvc3NPcmlnaW5BdHRyaWJ1dGV9IHNyYz1cIiR7dXJsfVwiPjwvc2NyaXB0PmA7XG4gICAgfVxuICApO1xuICBjb25zdCBwcmVsb2FkZWQgPSBnZXRVcmxzKFxuICAgIGN0eCxcbiAgICBjdHgucHJlbG9hZENodW5rcy5maWx0ZXIoKGl0ZW0pID0+ICFjdHguc3luY0NodW5rcy5pbmNsdWRlcyhpdGVtKSlcbiAgKS5tYXAoKHt1cmwsIGNyb3NzT3JpZ2luQXR0cmlidXRlfSkgPT4ge1xuICAgIHJldHVybiBgPHNjcmlwdCBub25jZT1cIiR7Y3R4Lm5vbmNlfVwiIGRlZmVyJHtjcm9zc09yaWdpbkF0dHJpYnV0ZX0gc3JjPVwiJHt1cmx9XCI+PC9zY3JpcHQ+YDtcbiAgfSk7XG4gIHJldHVybiBbLi4ucHJlbG9hZGVkLCAuLi5zeW5jXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0UHJlbG9hZEhpbnRMaW5rcyhjdHgpIHtcbiAgY29uc3QgY2h1bmtzID0gWy4uLmN0eC5wcmVsb2FkQ2h1bmtzLCAuLi5jdHguc3luY0NodW5rc107XG4gIGNvbnN0IGhpbnRzID0gZ2V0VXJscyhjdHgsIGNodW5rcykubWFwKCh7dXJsLCBjcm9zc09yaWdpbkF0dHJpYnV0ZX0pID0+IHtcbiAgICByZXR1cm4gYDxsaW5rIHJlbD1cInByZWxvYWRcIiR7Y3Jvc3NPcmlnaW5BdHRyaWJ1dGV9IGhyZWY9XCIke3VybH1cIiBub25jZT1cIiR7Y3R4Lm5vbmNlfVwiIGFzPVwic2NyaXB0XCIgLz5gO1xuICB9KTtcbiAgcmV0dXJuIGhpbnRzLmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBnZXRTZXJpYWxpemVkVW5pdmVyc2FsVmFsdWVzKGN0eCkge1xuICBjb25zdCBhcHAgPSBjdHhbYXBwU3ltYm9sXTtcbiAgcmV0dXJuIGh0bWxgPHNjcmlwdCB0eXBlPVwiYXBwbGljYXRpb24vanNvblwiIGlkPVwiX19GVVNJT05fVU5JVkVSU0FMX1ZBTFVFU19fXCI+XG4gICAgJHtKU09OLnN0cmluZ2lmeSh7Li4uYXBwLnVuaXZlcnNhbFZhbHVlcywgLi4uY3R4LnVuaXZlcnNhbFZhbHVlc30pfVxuICA8L3NjcmlwdD5gO1xufVxuIl19