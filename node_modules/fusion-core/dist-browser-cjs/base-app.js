"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _createPlugin = require("./create-plugin");

var _createToken = require("./create-token");

var _tokens = require("./tokens");

var _ssr = require("./plugins/ssr");

var _routeTags = _interopRequireDefault(require("./plugins/route-tags"));

var _stackTrace = require("./stack-trace.js");

var _core = require("./core.js");

var _legacyCompat = require("./legacy-compat.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */

/* eslint-disable require-yield */
class BaseApp extends _core.App {
  constructor(el, render) {
    super();
    this.registered = new Map(); // getTokenRef(token) -> {value, aliases, enhancers}

    this.plugins = []; // Token

    el && this.register(_tokens.ElementToken, el);

    if (render) {
      this.renderer = render;
    }

    this.register(_tokens.SSRDeciderToken, _ssr.SSRDecider);
    this.register(_tokens.RouteTagsToken, _routeTags.default);
    this.done = false;
  }

  register(tokenOrValue, maybeValue) {
    const hasToken = tokenOrValue instanceof _createToken.TokenImpl;
    const token = hasToken ? tokenOrValue : (0, _createToken.createToken)('UnnamedPlugin');
    const value = hasToken ? maybeValue : tokenOrValue;

    if (!hasToken && (value == null || !(0, _createPlugin.getPluginFn)(value))) {
      throw new _stackTrace.DIError({
        message: process.env.NODE_ENV !== "production" ? `Cannot register ${String(tokenOrValue)} without a token. Did you accidentally register a ${false ? 'browser' : 'server'} plugin on the ${false ? 'server' : 'browser'}?` : 'Invalid configuration registration',
        errorDoc: 'value-without-token',
        caller: this.register
      });
    } // the renderer is a special case, since it needs to be always run last


    if (token === _tokens.RenderToken) {
      this.renderer = value;

      const alias = () => {
        throw new _stackTrace.DIError({
          message: 'Aliasing for RenderToken not supported',
          caller: alias
        });
      };

      return {
        alias
      };
    }

    token.stacks.push({
      type: 'register',
      stack: (0, _stackTrace.captureStackTrace)(this.register)
    });

    if (value && value.__plugin__) {
      token.stacks.push({
        type: 'plugin',
        stack: value.stack
      });
    }

    return this._register(token, value);
  }

  _register(token, value) {
    const foundPluginFn = (0, _createPlugin.getPluginFn)(value); // const registerResult = super.registerPlugin(token, value);

    const registerResult = super.registerPlugin(token, foundPluginFn ? foundPluginFn : (0, _createPlugin.declarePlugin)(function* () {
      return value;
    })); // getPluginFn(valaue)
    //   ? super.registerPlugin(token, value.__fn__)
    //   : super.registerPlugin(
    //       token,
    //       declarePlugin(function* () {
    //         return value;
    //       })
    //     );
    // For introspect plugin

    const {
      aliases,
      enhancers
    } = this.registered.get((0, _createToken.getTokenRef)(token)) || {
      aliases: new Map(),
      enhancers: []
    };
    this.registered.set((0, _createToken.getTokenRef)(token), {
      value,
      aliases,
      enhancers,
      token
    });

    const alias = (sourceToken, destToken) => {
      registerResult.alias(sourceToken, destToken);
      const stack = (0, _stackTrace.captureStackTrace)(alias);
      sourceToken.stacks.push({
        type: 'alias-from',
        stack
      });
      destToken.stacks.push({
        type: 'alias-to',
        stack
      });
      return {
        alias
      };
    };

    return {
      alias
    };
  }

  middleware(deps, middleware) {
    if (middleware === undefined) {
      middleware = () => deps;
    }

    this.register((0, _createPlugin.createPlugin)({
      deps: deps,
      middleware
    }));
  }

  enhance(token, enhancer) {
    token.stacks.push({
      type: 'enhance',
      stack: (0, _stackTrace.captureStackTrace)(this.enhance)
    }); // For introspect plugin

    const {
      value,
      aliases,
      enhancers
    } = this.registered.get((0, _createToken.getTokenRef)(token)) || {
      aliases: new Map(),
      enhancers: [],
      value: undefined
    };

    if (enhancers && Array.isArray(enhancers)) {
      enhancers.push(enhancer);
    }

    this.registered.set((0, _createToken.getTokenRef)(token), {
      value,
      aliases,
      enhancers,
      token
    });
    return super.enhance(token, enhancer);
  }

  cleanup() {
    return Promise.all(this.cleanups.map(fn => fn()));
  }

  resolve() {
    if (!this.renderer) {
      throw new Error('Missing registration for RenderToken');
    }

    this._register(_tokens.RenderToken, this.renderer);

    if (this.registeredTokens.has((0, _createToken.getTokenRef)(_tokens.EnableMiddlewareTimingToken))) {
      this.enableMiddlewareTiming = true;
    } // Note that core init actually returns a promise.
    // However, core init will synchronously complete as long as there is no
    // async tasks. The only planned async hook is withStartup(), which is not
    // currently implemented. Introducing async startup is technically a
    // breaking change, which we are avoiding initially. When we want to make
    // this breaking change and introduce withStartup(), we should add an await
    // to the statement below


    super.init();
    (0, _legacyCompat.sortLegacy)(this); // Preserve legacy order for compatibility

    this.done = true;
  }

  getService(token) {
    if (!this.done) {
      throw new _stackTrace.DIError({
        message: 'Cannot get service from unresolved app',
        caller: this.getService
      });
    }

    const result = (0, _core.getResolvedDep)(this, token);

    if (result.resolved) {
      return result.value;
    }
  }

  callback() {}

}

var _default = BaseApp;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9iYXNlLWFwcC5qcyJdLCJuYW1lcyI6WyJCYXNlQXBwIiwiQ29yZSIsImNvbnN0cnVjdG9yIiwiZWwiLCJyZW5kZXIiLCJyZWdpc3RlcmVkIiwiTWFwIiwicGx1Z2lucyIsInJlZ2lzdGVyIiwiRWxlbWVudFRva2VuIiwicmVuZGVyZXIiLCJTU1JEZWNpZGVyVG9rZW4iLCJTU1JEZWNpZGVyIiwiUm91dGVUYWdzVG9rZW4iLCJSb3V0ZVRhZ3NQbHVnaW4iLCJkb25lIiwidG9rZW5PclZhbHVlIiwibWF5YmVWYWx1ZSIsImhhc1Rva2VuIiwiVG9rZW5JbXBsIiwidG9rZW4iLCJ2YWx1ZSIsIkRJRXJyb3IiLCJtZXNzYWdlIiwiU3RyaW5nIiwiZXJyb3JEb2MiLCJjYWxsZXIiLCJSZW5kZXJUb2tlbiIsImFsaWFzIiwic3RhY2tzIiwicHVzaCIsInR5cGUiLCJzdGFjayIsIl9fcGx1Z2luX18iLCJfcmVnaXN0ZXIiLCJmb3VuZFBsdWdpbkZuIiwicmVnaXN0ZXJSZXN1bHQiLCJyZWdpc3RlclBsdWdpbiIsImFsaWFzZXMiLCJlbmhhbmNlcnMiLCJnZXQiLCJzZXQiLCJzb3VyY2VUb2tlbiIsImRlc3RUb2tlbiIsIm1pZGRsZXdhcmUiLCJkZXBzIiwidW5kZWZpbmVkIiwiZW5oYW5jZSIsImVuaGFuY2VyIiwiQXJyYXkiLCJpc0FycmF5IiwiY2xlYW51cCIsIlByb21pc2UiLCJhbGwiLCJjbGVhbnVwcyIsIm1hcCIsImZuIiwicmVzb2x2ZSIsIkVycm9yIiwicmVnaXN0ZXJlZFRva2VucyIsImhhcyIsIkVuYWJsZU1pZGRsZXdhcmVUaW1pbmdUb2tlbiIsImVuYWJsZU1pZGRsZXdhcmVUaW1pbmciLCJpbml0IiwiZ2V0U2VydmljZSIsInJlc3VsdCIsInJlc29sdmVkIiwiY2FsbGJhY2siXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFTQTs7QUFDQTs7QUFDQTs7QUFPQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7OztBQXZCQTtBQUNBO0FBQ0E7QUFDQTtB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QUwsQ0FBY0MsR0FBZCxDQUFtQkMsRUFBRCxJQUFRQSxFQUFFLEVBQTVCLENBQVosQ0FBUDtBQUNEOztBQUVEQyxFQUFBQSxPQUFPLEdBQUc7QUFDUixRQUFJLENBQUMsS0FBSy9DLFFBQVYsRUFBb0I7QUFDbEIsWUFBTSxJQUFJZ0QsS0FBSixDQUFVLHNDQUFWLENBQU47QUFDRDs7QUFDRCxTQUFLeEIsU0FBTCxDQUFlUCxtQkFBZixFQUE0QixLQUFLakIsUUFBakM7O0FBRUEsUUFBSSxLQUFLaUQsZ0JBQUwsQ0FBc0JDLEdBQXRCLENBQTBCLDhCQUFZQyxtQ0FBWixDQUExQixDQUFKLEVBQXlFO0FBQ3ZFLFdBQUtDLHNCQUFMLEdBQThCLElBQTlCO0FBQ0QsS0FSTyxDQVVSO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQSxVQUFNQyxJQUFOO0FBRUEsa0NBQVcsSUFBWCxFQW5CUSxDQW1CVTs7QUFFbEIsU0FBS2hELElBQUwsR0FBWSxJQUFaO0FBQ0Q7O0FBRURpRCxFQUFBQSxVQUFVLENBQUM1QyxLQUFELEVBQVE7QUFDaEIsUUFBSSxDQUFDLEtBQUtMLElBQVYsRUFBZ0I7QUFDZCxZQUFNLElBQUlPLG1CQUFKLENBQVk7QUFDaEJDLFFBQUFBLE9BQU8sRUFBRSx3Q0FETztBQUVoQkcsUUFBQUEsTUFBTSxFQUFFLEtBQUtzQztBQUZHLE9BQVosQ0FBTjtBQUlEOztBQUNELFVBQU1DLE1BQU0sR0FBRywwQkFBZSxJQUFmLEVBQXFCN0MsS0FBckIsQ0FBZjs7QUFDQSxRQUFJNkMsTUFBTSxDQUFDQyxRQUFYLEVBQXFCO0FBQ25CLGFBQU9ELE1BQU0sQ0FBQzVDLEtBQWQ7QUFDRDtBQUNGOztBQUVEOEMsRUFBQUEsUUFBUSxHQUFHLENBQUU7O0FBN0tZOztlQWdMWm5FLE8iLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQG5vZmxvd1xuICovXG5cbi8qIGVzbGludC1kaXNhYmxlIHJlcXVpcmUteWllbGQgKi9cbmltcG9ydCB7Y3JlYXRlUGx1Z2luLCBkZWNsYXJlUGx1Z2luLCBnZXRQbHVnaW5Gbn0gZnJvbSAnLi9jcmVhdGUtcGx1Z2luJztcbmltcG9ydCB7Y3JlYXRlVG9rZW4sIGdldFRva2VuUmVmLCBUb2tlbkltcGx9IGZyb20gJy4vY3JlYXRlLXRva2VuJztcbmltcG9ydCB7XG4gIEVsZW1lbnRUb2tlbixcbiAgUmVuZGVyVG9rZW4sXG4gIFNTUkRlY2lkZXJUb2tlbixcbiAgUm91dGVUYWdzVG9rZW4sXG4gIEVuYWJsZU1pZGRsZXdhcmVUaW1pbmdUb2tlbixcbn0gZnJvbSAnLi90b2tlbnMnO1xuaW1wb3J0IHtTU1JEZWNpZGVyfSBmcm9tICcuL3BsdWdpbnMvc3NyJztcbmltcG9ydCBSb3V0ZVRhZ3NQbHVnaW4gZnJvbSAnLi9wbHVnaW5zL3JvdXRlLXRhZ3MnO1xuaW1wb3J0IHtjYXB0dXJlU3RhY2tUcmFjZSwgRElFcnJvcn0gZnJvbSAnLi9zdGFjay10cmFjZS5qcyc7XG5cbmltcG9ydCB7QXBwIGFzIENvcmUsIGdldFJlc29sdmVkRGVwfSBmcm9tICcuL2NvcmUuanMnO1xuaW1wb3J0IHtzb3J0TGVnYWN5fSBmcm9tICcuL2xlZ2FjeS1jb21wYXQuanMnO1xuXG5jbGFzcyBCYXNlQXBwIGV4dGVuZHMgQ29yZSB7XG4gIGNvbnN0cnVjdG9yKGVsLCByZW5kZXIpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMucmVnaXN0ZXJlZCA9IG5ldyBNYXAoKTsgLy8gZ2V0VG9rZW5SZWYodG9rZW4pIC0+IHt2YWx1ZSwgYWxpYXNlcywgZW5oYW5jZXJzfVxuICAgIHRoaXMucGx1Z2lucyA9IFtdOyAvLyBUb2tlblxuICAgIGVsICYmIHRoaXMucmVnaXN0ZXIoRWxlbWVudFRva2VuLCBlbCk7XG4gICAgaWYgKHJlbmRlcikge1xuICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcjtcbiAgICB9XG4gICAgdGhpcy5yZWdpc3RlcihTU1JEZWNpZGVyVG9rZW4sIFNTUkRlY2lkZXIpO1xuICAgIHRoaXMucmVnaXN0ZXIoUm91dGVUYWdzVG9rZW4sIFJvdXRlVGFnc1BsdWdpbik7XG4gICAgdGhpcy5kb25lID0gZmFsc2U7XG4gIH1cblxuICByZWdpc3Rlcih0b2tlbk9yVmFsdWUsIG1heWJlVmFsdWUpIHtcbiAgICBjb25zdCBoYXNUb2tlbiA9IHRva2VuT3JWYWx1ZSBpbnN0YW5jZW9mIFRva2VuSW1wbDtcbiAgICBjb25zdCB0b2tlbiA9IGhhc1Rva2VuID8gdG9rZW5PclZhbHVlIDogY3JlYXRlVG9rZW4oJ1VubmFtZWRQbHVnaW4nKTtcbiAgICBjb25zdCB2YWx1ZSA9IGhhc1Rva2VuID8gbWF5YmVWYWx1ZSA6IHRva2VuT3JWYWx1ZTtcbiAgICBpZiAoIWhhc1Rva2VuICYmICh2YWx1ZSA9PSBudWxsIHx8ICFnZXRQbHVnaW5Gbih2YWx1ZSkpKSB7XG4gICAgICB0aHJvdyBuZXcgRElFcnJvcih7XG4gICAgICAgIG1lc3NhZ2U6IF9fREVWX19cbiAgICAgICAgICA/IGBDYW5ub3QgcmVnaXN0ZXIgJHtTdHJpbmcoXG4gICAgICAgICAgICAgIHRva2VuT3JWYWx1ZVxuICAgICAgICAgICAgKX0gd2l0aG91dCBhIHRva2VuLiBEaWQgeW91IGFjY2lkZW50YWxseSByZWdpc3RlciBhICR7XG4gICAgICAgICAgICAgIF9fTk9ERV9fID8gJ2Jyb3dzZXInIDogJ3NlcnZlcidcbiAgICAgICAgICAgIH0gcGx1Z2luIG9uIHRoZSAke19fTk9ERV9fID8gJ3NlcnZlcicgOiAnYnJvd3Nlcid9P2BcbiAgICAgICAgICA6ICdJbnZhbGlkIGNvbmZpZ3VyYXRpb24gcmVnaXN0cmF0aW9uJyxcbiAgICAgICAgZXJyb3JEb2M6ICd2YWx1ZS13aXRob3V0LXRva2VuJyxcbiAgICAgICAgY2FsbGVyOiB0aGlzLnJlZ2lzdGVyLFxuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIHRoZSByZW5kZXJlciBpcyBhIHNwZWNpYWwgY2FzZSwgc2luY2UgaXQgbmVlZHMgdG8gYmUgYWx3YXlzIHJ1biBsYXN0XG4gICAgaWYgKHRva2VuID09PSBSZW5kZXJUb2tlbikge1xuICAgICAgdGhpcy5yZW5kZXJlciA9IHZhbHVlO1xuICAgICAgY29uc3QgYWxpYXMgPSAoKSA9PiB7XG4gICAgICAgIHRocm93IG5ldyBESUVycm9yKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQWxpYXNpbmcgZm9yIFJlbmRlclRva2VuIG5vdCBzdXBwb3J0ZWQnLFxuICAgICAgICAgIGNhbGxlcjogYWxpYXMsXG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICAgIHJldHVybiB7YWxpYXN9O1xuICAgIH1cbiAgICB0b2tlbi5zdGFja3MucHVzaCh7XG4gICAgICB0eXBlOiAncmVnaXN0ZXInLFxuICAgICAgc3RhY2s6IGNhcHR1cmVTdGFja1RyYWNlKHRoaXMucmVnaXN0ZXIpLFxuICAgIH0pO1xuICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5fX3BsdWdpbl9fKSB7XG4gICAgICB0b2tlbi5zdGFja3MucHVzaCh7dHlwZTogJ3BsdWdpbicsIHN0YWNrOiB2YWx1ZS5zdGFja30pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fcmVnaXN0ZXIodG9rZW4sIHZhbHVlKTtcbiAgfVxuXG4gIF9yZWdpc3Rlcih0b2tlbiwgdmFsdWUpIHtcbiAgICBjb25zdCBmb3VuZFBsdWdpbkZuID0gZ2V0UGx1Z2luRm4odmFsdWUpO1xuXG4gICAgLy8gY29uc3QgcmVnaXN0ZXJSZXN1bHQgPSBzdXBlci5yZWdpc3RlclBsdWdpbih0b2tlbiwgdmFsdWUpO1xuXG4gICAgY29uc3QgcmVnaXN0ZXJSZXN1bHQgPSBzdXBlci5yZWdpc3RlclBsdWdpbihcbiAgICAgIHRva2VuLFxuICAgICAgZm91bmRQbHVnaW5GblxuICAgICAgICA/IGZvdW5kUGx1Z2luRm5cbiAgICAgICAgOiBkZWNsYXJlUGx1Z2luKGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgICAgfSlcbiAgICApO1xuXG4gICAgLy8gZ2V0UGx1Z2luRm4odmFsYXVlKVxuICAgIC8vICAgPyBzdXBlci5yZWdpc3RlclBsdWdpbih0b2tlbiwgdmFsdWUuX19mbl9fKVxuICAgIC8vICAgOiBzdXBlci5yZWdpc3RlclBsdWdpbihcbiAgICAvLyAgICAgICB0b2tlbixcbiAgICAvLyAgICAgICBkZWNsYXJlUGx1Z2luKGZ1bmN0aW9uKiAoKSB7XG4gICAgLy8gICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgLy8gICAgICAgfSlcbiAgICAvLyAgICAgKTtcblxuICAgIC8vIEZvciBpbnRyb3NwZWN0IHBsdWdpblxuICAgIGNvbnN0IHthbGlhc2VzLCBlbmhhbmNlcnN9ID0gdGhpcy5yZWdpc3RlcmVkLmdldChnZXRUb2tlblJlZih0b2tlbikpIHx8IHtcbiAgICAgIGFsaWFzZXM6IG5ldyBNYXAoKSxcbiAgICAgIGVuaGFuY2VyczogW10sXG4gICAgfTtcbiAgICB0aGlzLnJlZ2lzdGVyZWQuc2V0KGdldFRva2VuUmVmKHRva2VuKSwge1xuICAgICAgdmFsdWUsXG4gICAgICBhbGlhc2VzLFxuICAgICAgZW5oYW5jZXJzLFxuICAgICAgdG9rZW4sXG4gICAgfSk7XG5cbiAgICBjb25zdCBhbGlhcyA9IChzb3VyY2VUb2tlbiwgZGVzdFRva2VuKSA9PiB7XG4gICAgICByZWdpc3RlclJlc3VsdC5hbGlhcyhzb3VyY2VUb2tlbiwgZGVzdFRva2VuKTtcbiAgICAgIGNvbnN0IHN0YWNrID0gY2FwdHVyZVN0YWNrVHJhY2UoYWxpYXMpO1xuICAgICAgc291cmNlVG9rZW4uc3RhY2tzLnB1c2goe3R5cGU6ICdhbGlhcy1mcm9tJywgc3RhY2t9KTtcbiAgICAgIGRlc3RUb2tlbi5zdGFja3MucHVzaCh7dHlwZTogJ2FsaWFzLXRvJywgc3RhY2t9KTtcbiAgICAgIHJldHVybiB7YWxpYXN9O1xuICAgIH07XG4gICAgcmV0dXJuIHthbGlhc307XG4gIH1cblxuICBtaWRkbGV3YXJlKGRlcHMsIG1pZGRsZXdhcmUpIHtcbiAgICBpZiAobWlkZGxld2FyZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBtaWRkbGV3YXJlID0gKCkgPT4gZGVwcztcbiAgICB9XG4gICAgdGhpcy5yZWdpc3RlcihjcmVhdGVQbHVnaW4oe2RlcHM6IGRlcHMsIG1pZGRsZXdhcmV9KSk7XG4gIH1cblxuICBlbmhhbmNlKHRva2VuLCBlbmhhbmNlcikge1xuICAgIHRva2VuLnN0YWNrcy5wdXNoKHtcbiAgICAgIHR5cGU6ICdlbmhhbmNlJyxcbiAgICAgIHN0YWNrOiBjYXB0dXJlU3RhY2tUcmFjZSh0aGlzLmVuaGFuY2UpLFxuICAgIH0pO1xuXG4gICAgLy8gRm9yIGludHJvc3BlY3QgcGx1Z2luXG4gICAgY29uc3Qge3ZhbHVlLCBhbGlhc2VzLCBlbmhhbmNlcnN9ID0gdGhpcy5yZWdpc3RlcmVkLmdldChcbiAgICAgIGdldFRva2VuUmVmKHRva2VuKVxuICAgICkgfHwge1xuICAgICAgYWxpYXNlczogbmV3IE1hcCgpLFxuICAgICAgZW5oYW5jZXJzOiBbXSxcbiAgICAgIHZhbHVlOiB1bmRlZmluZWQsXG4gICAgfTtcblxuICAgIGlmIChlbmhhbmNlcnMgJiYgQXJyYXkuaXNBcnJheShlbmhhbmNlcnMpKSB7XG4gICAgICBlbmhhbmNlcnMucHVzaChlbmhhbmNlcik7XG4gICAgfVxuICAgIHRoaXMucmVnaXN0ZXJlZC5zZXQoZ2V0VG9rZW5SZWYodG9rZW4pLCB7XG4gICAgICB2YWx1ZSxcbiAgICAgIGFsaWFzZXMsXG4gICAgICBlbmhhbmNlcnMsXG4gICAgICB0b2tlbixcbiAgICB9KTtcblxuICAgIHJldHVybiBzdXBlci5lbmhhbmNlKHRva2VuLCBlbmhhbmNlcik7XG4gIH1cblxuICBjbGVhbnVwKCkge1xuICAgIHJldHVybiBQcm9taXNlLmFsbCh0aGlzLmNsZWFudXBzLm1hcCgoZm4pID0+IGZuKCkpKTtcbiAgfVxuXG4gIHJlc29sdmUoKSB7XG4gICAgaWYgKCF0aGlzLnJlbmRlcmVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgcmVnaXN0cmF0aW9uIGZvciBSZW5kZXJUb2tlbicpO1xuICAgIH1cbiAgICB0aGlzLl9yZWdpc3RlcihSZW5kZXJUb2tlbiwgdGhpcy5yZW5kZXJlcik7XG5cbiAgICBpZiAodGhpcy5yZWdpc3RlcmVkVG9rZW5zLmhhcyhnZXRUb2tlblJlZihFbmFibGVNaWRkbGV3YXJlVGltaW5nVG9rZW4pKSkge1xuICAgICAgdGhpcy5lbmFibGVNaWRkbGV3YXJlVGltaW5nID0gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBOb3RlIHRoYXQgY29yZSBpbml0IGFjdHVhbGx5IHJldHVybnMgYSBwcm9taXNlLlxuICAgIC8vIEhvd2V2ZXIsIGNvcmUgaW5pdCB3aWxsIHN5bmNocm9ub3VzbHkgY29tcGxldGUgYXMgbG9uZyBhcyB0aGVyZSBpcyBub1xuICAgIC8vIGFzeW5jIHRhc2tzLiBUaGUgb25seSBwbGFubmVkIGFzeW5jIGhvb2sgaXMgd2l0aFN0YXJ0dXAoKSwgd2hpY2ggaXMgbm90XG4gICAgLy8gY3VycmVudGx5IGltcGxlbWVudGVkLiBJbnRyb2R1Y2luZyBhc3luYyBzdGFydHVwIGlzIHRlY2huaWNhbGx5IGFcbiAgICAvLyBicmVha2luZyBjaGFuZ2UsIHdoaWNoIHdlIGFyZSBhdm9pZGluZyBpbml0aWFsbHkuIFdoZW4gd2Ugd2FudCB0byBtYWtlXG4gICAgLy8gdGhpcyBicmVha2luZyBjaGFuZ2UgYW5kIGludHJvZHVjZSB3aXRoU3RhcnR1cCgpLCB3ZSBzaG91bGQgYWRkIGFuIGF3YWl0XG4gICAgLy8gdG8gdGhlIHN0YXRlbWVudCBiZWxvd1xuICAgIHN1cGVyLmluaXQoKTtcblxuICAgIHNvcnRMZWdhY3kodGhpcyk7IC8vIFByZXNlcnZlIGxlZ2FjeSBvcmRlciBmb3IgY29tcGF0aWJpbGl0eVxuXG4gICAgdGhpcy5kb25lID0gdHJ1ZTtcbiAgfVxuXG4gIGdldFNlcnZpY2UodG9rZW4pIHtcbiAgICBpZiAoIXRoaXMuZG9uZSkge1xuICAgICAgdGhyb3cgbmV3IERJRXJyb3Ioe1xuICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IGdldCBzZXJ2aWNlIGZyb20gdW5yZXNvbHZlZCBhcHAnLFxuICAgICAgICBjYWxsZXI6IHRoaXMuZ2V0U2VydmljZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBnZXRSZXNvbHZlZERlcCh0aGlzLCB0b2tlbik7XG4gICAgaWYgKHJlc3VsdC5yZXNvbHZlZCkge1xuICAgICAgcmV0dXJuIHJlc3VsdC52YWx1ZTtcbiAgICB9XG4gIH1cblxuICBjYWxsYmFjaygpIHt9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEJhc2VBcHA7XG4iXX0=