"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _compose = require("./compose.js");

var _timing = _interopRequireWildcard(require("./plugins/timing"));

var _baseApp = _interopRequireDefault(require("./base-app"));

var _clientHydrate = _interopRequireWildcard(require("./plugins/client-hydrate"));

var _clientRenderer = _interopRequireDefault(require("./plugins/client-renderer"));

var _tokens = require("./tokens");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */

/* eslint-env browser */
function _default() {
  return class ClientApp extends _baseApp.default {
    constructor(el, render) {
      super(el, render);
      this.register(_timing.TimingToken, _timing.default);
      this.middleware({
        element: _tokens.ElementToken
      }, _clientHydrate.default);
    }

    resolve() {
      this.middleware({
        render: _tokens.RenderToken
      }, (0, _clientRenderer.default)(this));
      return super.resolve();
    }

    callback() {
      this.resolve();
      const middleware = (0, _compose.compose)(this.plugins);
      return () => {
        // TODO(#62): Create noop context object to match server api
        const routePrefix = (0, _clientHydrate.getSerializedRoutePrefix)();
        const replaceRouteRegex = new RegExp(`^${routePrefix}`);
        const ctx = {
          url: (window.location.pathname + window.location.search).replace(replaceRouteRegex, ''),
          element: null,
          body: null
        };
        return middleware(ctx, () => Promise.resolve()).then(() => ctx);
      };
    }

  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9jbGllbnQtYXBwLmpzIl0sIm5hbWVzIjpbIkNsaWVudEFwcCIsIkJhc2VBcHAiLCJjb25zdHJ1Y3RvciIsImVsIiwicmVuZGVyIiwicmVnaXN0ZXIiLCJUaW1pbmdUb2tlbiIsInRpbWluZyIsIm1pZGRsZXdhcmUiLCJlbGVtZW50IiwiRWxlbWVudFRva2VuIiwiY3JlYXRlQ2xpZW50SHlkcmF0ZSIsInJlc29sdmUiLCJSZW5kZXJUb2tlbiIsImNhbGxiYWNrIiwicGx1Z2lucyIsInJvdXRlUHJlZml4IiwicmVwbGFjZVJvdXRlUmVnZXgiLCJSZWdFeHAiLCJjdHgiLCJ1cmwiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsInBhdGhuYW1lIiwic2VhcmNoIiwicmVwbGFjZSIsImJvZHkiLCJQcm9taXNlIiwidGhlbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQVFBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOzs7Ozs7OztBQWZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUNBO0FBVWUsb0JBQVk7QUFDekIsU0FBTyxNQUFNQSxTQUFOLFNBQXdCQyxnQkFBeEIsQ0FBZ0M7QUFDckNDLElBQUFBLFdBQVcsQ0FBQ0MsRUFBRCxFQUFLQyxNQUFMLEVBQWE7QUFDdEIsWUFBTUQsRUFBTixFQUFVQyxNQUFWO0FBQ0EsV0FBS0MsUUFBTCxDQUFjQyxtQkFBZCxFQUEyQkMsZUFBM0I7QUFDQSxXQUFLQyxVQUFMLENBQWdCO0FBQUNDLFFBQUFBLE9BQU8sRUFBRUM7QUFBVixPQUFoQixFQUF5Q0Msc0JBQXpDO0FBQ0Q7O0FBQ0RDLElBQUFBLE9BQU8sR0FBRztBQUNSLFdBQUtKLFVBQUwsQ0FBZ0I7QUFBQ0osUUFBQUEsTUFBTSxFQUFFUztBQUFULE9BQWhCLEVBQXVDLDZCQUFxQixJQUFyQixDQUF2QztBQUNBLGFBQU8sTUFBTUQsT0FBTixFQUFQO0FBQ0Q7O0FBQ0RFLElBQUFBLFFBQVEsR0FBRztBQUNULFdBQUtGLE9BQUw7QUFDQSxZQUFNSixVQUFVLEdBQUcsc0JBQVEsS0FBS08sT0FBYixDQUFuQjtBQUNBLGFBQU8sTUFBTTtBQUNYO0FBQ0EsY0FBTUMsV0FBVyxHQUFHLDhDQUFwQjtBQUNBLGNBQU1DLGlCQUFpQixHQUFHLElBQUlDLE1BQUosQ0FBWSxJQUFHRixXQUFZLEVBQTNCLENBQTFCO0FBQ0EsY0FBTUcsR0FBRyxHQUFHO0FBQ1ZDLFVBQUFBLEdBQUcsRUFBRSxDQUFDQyxNQUFNLENBQUNDLFFBQVAsQ0FBZ0JDLFFBQWhCLEdBQTJCRixNQUFNLENBQUNDLFFBQVAsQ0FBZ0JFLE1BQTVDLEVBQW9EQyxPQUFwRCxDQUNIUixpQkFERyxFQUVILEVBRkcsQ0FESztBQUtWUixVQUFBQSxPQUFPLEVBQUUsSUFMQztBQU1WaUIsVUFBQUEsSUFBSSxFQUFFO0FBTkksU0FBWjtBQVFBLGVBQU9sQixVQUFVLENBQUNXLEdBQUQsRUFBTSxNQUFNUSxPQUFPLENBQUNmLE9BQVIsRUFBWixDQUFWLENBQXlDZ0IsSUFBekMsQ0FBOEMsTUFBTVQsR0FBcEQsQ0FBUDtBQUNELE9BYkQ7QUFjRDs7QUEzQm9DLEdBQXZDO0FBNkJEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBub2Zsb3dcbiAqL1xuLyogZXNsaW50LWVudiBicm93c2VyICovXG5pbXBvcnQge2NvbXBvc2V9IGZyb20gJy4vY29tcG9zZS5qcyc7XG5pbXBvcnQgdGltaW5nLCB7VGltaW5nVG9rZW59IGZyb20gJy4vcGx1Z2lucy90aW1pbmcnO1xuaW1wb3J0IEJhc2VBcHAgZnJvbSAnLi9iYXNlLWFwcCc7XG5pbXBvcnQgY3JlYXRlQ2xpZW50SHlkcmF0ZSwge1xuICBnZXRTZXJpYWxpemVkUm91dGVQcmVmaXgsXG59IGZyb20gJy4vcGx1Z2lucy9jbGllbnQtaHlkcmF0ZSc7XG5pbXBvcnQgY3JlYXRlQ2xpZW50UmVuZGVyZXIgZnJvbSAnLi9wbHVnaW5zL2NsaWVudC1yZW5kZXJlcic7XG5pbXBvcnQge1JlbmRlclRva2VuLCBFbGVtZW50VG9rZW59IGZyb20gJy4vdG9rZW5zJztcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKCkge1xuICByZXR1cm4gY2xhc3MgQ2xpZW50QXBwIGV4dGVuZHMgQmFzZUFwcCB7XG4gICAgY29uc3RydWN0b3IoZWwsIHJlbmRlcikge1xuICAgICAgc3VwZXIoZWwsIHJlbmRlcik7XG4gICAgICB0aGlzLnJlZ2lzdGVyKFRpbWluZ1Rva2VuLCB0aW1pbmcpO1xuICAgICAgdGhpcy5taWRkbGV3YXJlKHtlbGVtZW50OiBFbGVtZW50VG9rZW59LCBjcmVhdGVDbGllbnRIeWRyYXRlKTtcbiAgICB9XG4gICAgcmVzb2x2ZSgpIHtcbiAgICAgIHRoaXMubWlkZGxld2FyZSh7cmVuZGVyOiBSZW5kZXJUb2tlbn0sIGNyZWF0ZUNsaWVudFJlbmRlcmVyKHRoaXMpKTtcbiAgICAgIHJldHVybiBzdXBlci5yZXNvbHZlKCk7XG4gICAgfVxuICAgIGNhbGxiYWNrKCkge1xuICAgICAgdGhpcy5yZXNvbHZlKCk7XG4gICAgICBjb25zdCBtaWRkbGV3YXJlID0gY29tcG9zZSh0aGlzLnBsdWdpbnMpO1xuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgLy8gVE9ETygjNjIpOiBDcmVhdGUgbm9vcCBjb250ZXh0IG9iamVjdCB0byBtYXRjaCBzZXJ2ZXIgYXBpXG4gICAgICAgIGNvbnN0IHJvdXRlUHJlZml4ID0gZ2V0U2VyaWFsaXplZFJvdXRlUHJlZml4KCk7XG4gICAgICAgIGNvbnN0IHJlcGxhY2VSb3V0ZVJlZ2V4ID0gbmV3IFJlZ0V4cChgXiR7cm91dGVQcmVmaXh9YCk7XG4gICAgICAgIGNvbnN0IGN0eCA9IHtcbiAgICAgICAgICB1cmw6ICh3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyB3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5yZXBsYWNlKFxuICAgICAgICAgICAgcmVwbGFjZVJvdXRlUmVnZXgsXG4gICAgICAgICAgICAnJ1xuICAgICAgICAgICksXG4gICAgICAgICAgZWxlbWVudDogbnVsbCxcbiAgICAgICAgICBib2R5OiBudWxsLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gbWlkZGxld2FyZShjdHgsICgpID0+IFByb21pc2UucmVzb2x2ZSgpKS50aGVuKCgpID0+IGN0eCk7XG4gICAgICB9O1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==