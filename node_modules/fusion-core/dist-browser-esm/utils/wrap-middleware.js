/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
import { now } from './now.js';

const getSources = stacks => {
  // stack is of format: 'at file_xyz.js (/some/file/system/path.js:30:1)\n'
  return stacks.map(({
    type,
    stack = ''
  }) => {
    return {
      type,
      source: stack.split('\n').map(line => line.match(/\((.*?)\)/)).filter(match => match && match[1]).map(match => match[1]).map(to => false ? path.relative(process.cwd(), to) : to).shift()
    };
  });
}; // Wraps middleware for measuring middleware timing


export default function wrapMiddleware(existingMiddleware, token) {
  return async (ctx, next) => {
    const downstreamStart = now();
    let upstreamStart = 0;
    const timing = {
      token: token.name,
      source: JSON.stringify(getSources(token.stacks)),
      downstream: -1,
      upstream: -1
    };

    if (ctx.timing) {
      ctx.timing.middleware.push(timing);
    }

    const wrapNext = async () => {
      timing.downstream = now() - downstreamStart;
      await next();
      upstreamStart = now();
    };

    await existingMiddleware(ctx, wrapNext);
    timing.upstream = now() - upstreamStart;
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy91dGlscy93cmFwLW1pZGRsZXdhcmUuanMiXSwibmFtZXMiOlsibm93IiwiZ2V0U291cmNlcyIsInN0YWNrcyIsIm1hcCIsInR5cGUiLCJzdGFjayIsInNvdXJjZSIsInNwbGl0IiwibGluZSIsIm1hdGNoIiwiZmlsdGVyIiwidG8iLCJwYXRoIiwicmVsYXRpdmUiLCJwcm9jZXNzIiwiY3dkIiwic2hpZnQiLCJ3cmFwTWlkZGxld2FyZSIsImV4aXN0aW5nTWlkZGxld2FyZSIsInRva2VuIiwiY3R4IiwibmV4dCIsImRvd25zdHJlYW1TdGFydCIsInVwc3RyZWFtU3RhcnQiLCJ0aW1pbmciLCJuYW1lIiwiSlNPTiIsInN0cmluZ2lmeSIsImRvd25zdHJlYW0iLCJ1cHN0cmVhbSIsIm1pZGRsZXdhcmUiLCJwdXNoIiwid3JhcE5leHQiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUEsU0FBUUEsR0FBUixRQUFrQixVQUFsQjs7QUFFQSxNQUFNQyxVQUFVLEdBQUlDLE1BQUQsSUFBWTtBQUM3QjtBQUNBLFNBQU9BLE1BQU0sQ0FBQ0MsR0FBUCxDQUFXLENBQUM7QUFBQ0MsSUFBQUEsSUFBRDtBQUFPQyxJQUFBQSxLQUFLLEdBQUc7QUFBZixHQUFELEtBQXdCO0FBQ3hDLFdBQU87QUFDTEQsTUFBQUEsSUFESztBQUVMRSxNQUFBQSxNQUFNLEVBQUVELEtBQUssQ0FDVkUsS0FESyxDQUNDLElBREQsRUFFTEosR0FGSyxDQUVBSyxJQUFELElBQVVBLElBQUksQ0FBQ0MsS0FBTCxDQUFXLFdBQVgsQ0FGVCxFQUdMQyxNQUhLLENBR0dELEtBQUQsSUFBV0EsS0FBSyxJQUFJQSxLQUFLLENBQUMsQ0FBRCxDQUgzQixFQUlMTixHQUpLLENBSUFNLEtBQUQsSUFBV0EsS0FBSyxDQUFDLENBQUQsQ0FKZixFQUtMTixHQUxLLENBS0FRLEVBQUQsSUFBUyxRQUFXQyxJQUFJLENBQUNDLFFBQUwsQ0FBY0MsT0FBTyxDQUFDQyxHQUFSLEVBQWQsRUFBNkJKLEVBQTdCLENBQVgsR0FBOENBLEVBTHRELEVBTUxLLEtBTks7QUFGSCxLQUFQO0FBVUQsR0FYTSxDQUFQO0FBWUQsQ0FkRCxDLENBZ0JBOzs7QUFDQSxlQUFlLFNBQVNDLGNBQVQsQ0FBd0JDLGtCQUF4QixFQUE0Q0MsS0FBNUMsRUFBbUQ7QUFDaEUsU0FBTyxPQUFPQyxHQUFQLEVBQVlDLElBQVosS0FBcUI7QUFDMUIsVUFBTUMsZUFBZSxHQUFHdEIsR0FBRyxFQUEzQjtBQUNBLFFBQUl1QixhQUFhLEdBQUcsQ0FBcEI7QUFFQSxVQUFNQyxNQUFNLEdBQUc7QUFDYkwsTUFBQUEsS0FBSyxFQUFFQSxLQUFLLENBQUNNLElBREE7QUFFYm5CLE1BQUFBLE1BQU0sRUFBRW9CLElBQUksQ0FBQ0MsU0FBTCxDQUFlMUIsVUFBVSxDQUFDa0IsS0FBSyxDQUFDakIsTUFBUCxDQUF6QixDQUZLO0FBR2IwQixNQUFBQSxVQUFVLEVBQUUsQ0FBQyxDQUhBO0FBSWJDLE1BQUFBLFFBQVEsRUFBRSxDQUFDO0FBSkUsS0FBZjs7QUFNQSxRQUFJVCxHQUFHLENBQUNJLE1BQVIsRUFBZ0I7QUFDZEosTUFBQUEsR0FBRyxDQUFDSSxNQUFKLENBQVdNLFVBQVgsQ0FBc0JDLElBQXRCLENBQTJCUCxNQUEzQjtBQUNEOztBQUVELFVBQU1RLFFBQVEsR0FBRyxZQUFZO0FBQzNCUixNQUFBQSxNQUFNLENBQUNJLFVBQVAsR0FBb0I1QixHQUFHLEtBQUtzQixlQUE1QjtBQUNBLFlBQU1ELElBQUksRUFBVjtBQUNBRSxNQUFBQSxhQUFhLEdBQUd2QixHQUFHLEVBQW5CO0FBQ0QsS0FKRDs7QUFLQSxVQUFNa0Isa0JBQWtCLENBQUNFLEdBQUQsRUFBTVksUUFBTixDQUF4QjtBQUNBUixJQUFBQSxNQUFNLENBQUNLLFFBQVAsR0FBa0I3QixHQUFHLEtBQUt1QixhQUExQjtBQUNELEdBckJEO0FBc0JEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBub2Zsb3dcbiAqL1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQge25vd30gZnJvbSAnLi9ub3cuanMnO1xuXG5jb25zdCBnZXRTb3VyY2VzID0gKHN0YWNrcykgPT4ge1xuICAvLyBzdGFjayBpcyBvZiBmb3JtYXQ6ICdhdCBmaWxlX3h5ei5qcyAoL3NvbWUvZmlsZS9zeXN0ZW0vcGF0aC5qczozMDoxKVxcbidcbiAgcmV0dXJuIHN0YWNrcy5tYXAoKHt0eXBlLCBzdGFjayA9ICcnfSkgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlLFxuICAgICAgc291cmNlOiBzdGFja1xuICAgICAgICAuc3BsaXQoJ1xcbicpXG4gICAgICAgIC5tYXAoKGxpbmUpID0+IGxpbmUubWF0Y2goL1xcKCguKj8pXFwpLykpXG4gICAgICAgIC5maWx0ZXIoKG1hdGNoKSA9PiBtYXRjaCAmJiBtYXRjaFsxXSlcbiAgICAgICAgLm1hcCgobWF0Y2gpID0+IG1hdGNoWzFdKVxuICAgICAgICAubWFwKCh0bykgPT4gKF9fTk9ERV9fID8gcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCB0bykgOiB0bykpXG4gICAgICAgIC5zaGlmdCgpLFxuICAgIH07XG4gIH0pO1xufTtcblxuLy8gV3JhcHMgbWlkZGxld2FyZSBmb3IgbWVhc3VyaW5nIG1pZGRsZXdhcmUgdGltaW5nXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB3cmFwTWlkZGxld2FyZShleGlzdGluZ01pZGRsZXdhcmUsIHRva2VuKSB7XG4gIHJldHVybiBhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgY29uc3QgZG93bnN0cmVhbVN0YXJ0ID0gbm93KCk7XG4gICAgbGV0IHVwc3RyZWFtU3RhcnQgPSAwO1xuXG4gICAgY29uc3QgdGltaW5nID0ge1xuICAgICAgdG9rZW46IHRva2VuLm5hbWUsXG4gICAgICBzb3VyY2U6IEpTT04uc3RyaW5naWZ5KGdldFNvdXJjZXModG9rZW4uc3RhY2tzKSksXG4gICAgICBkb3duc3RyZWFtOiAtMSxcbiAgICAgIHVwc3RyZWFtOiAtMSxcbiAgICB9O1xuICAgIGlmIChjdHgudGltaW5nKSB7XG4gICAgICBjdHgudGltaW5nLm1pZGRsZXdhcmUucHVzaCh0aW1pbmcpO1xuICAgIH1cblxuICAgIGNvbnN0IHdyYXBOZXh0ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgdGltaW5nLmRvd25zdHJlYW0gPSBub3coKSAtIGRvd25zdHJlYW1TdGFydDtcbiAgICAgIGF3YWl0IG5leHQoKTtcbiAgICAgIHVwc3RyZWFtU3RhcnQgPSBub3coKTtcbiAgICB9O1xuICAgIGF3YWl0IGV4aXN0aW5nTWlkZGxld2FyZShjdHgsIHdyYXBOZXh0KTtcbiAgICB0aW1pbmcudXBzdHJlYW0gPSBub3coKSAtIHVwc3RyZWFtU3RhcnQ7XG4gIH07XG59XG4iXX0=