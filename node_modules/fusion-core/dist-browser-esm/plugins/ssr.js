/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
import { createPlugin } from '../create-plugin';
import { escape, consumeSanitizedHTML, html } from '../sanitization';
import { appSymbol } from '../utils/app-symbol.js';
const botRegex = /(bot|crawler|spider)/i;
const SSRDecider = createPlugin({
  provides: () => {
    return ctx => {
      // If the request has one of these extensions, we assume it's not something that requires server-side rendering of virtual dom
      // TODO(#46): this check should probably look at the asset manifest to ensure asset 404s are handled correctly
      if (ctx.path.match(/\.(js|js\.map|gif|jpg|png|pdf|json|svg)$/)) return false; // Bots don't always include the accept header.

      if (ctx.headers['user-agent']) {
        const agent = ctx.headers['user-agent'];

        if (botRegex.test(agent) && ctx.method === 'GET') {
          return true;
        }
      } // The Accept header is a good proxy for whether SSR should happen
      // Requesting an HTML page via the browser url bar generates a request with `text/html` in its Accept headers
      // XHR/fetch requests do not have `text/html` in the Accept headers


      if (!ctx.headers.accept) return false;
      if (!ctx.headers.accept.includes('text/html')) return false;
      return true;
    };
  }
});
export { SSRDecider };
export default function createSSRPlugin(endpoints) {
  return function ssrMiddleware({
    element,
    ssrDecider,
    ssrBodyTemplate
  }) {
    return async function ssrMiddleware(ctx, next) {
      if (endpoints.has(ctx.path)) {
        return next();
      }

      if (!ssrDecider(ctx)) return next();
      const template = {
        htmlAttrs: {},
        bodyAttrs: {},
        title: '',
        head: [],
        body: []
      };
      ctx.element = element;
      ctx.rendered = '';
      ctx.template = template;
      ctx.type = 'text/html';
      await next(); // Allow someone to override the ssr by setting ctx.body
      // This is especially useful for things like ctx.redirect

      if (ctx.body && ctx.respond !== false) {
        return;
      }

      ctx.template.head.push(getSerializedUniversalValues(ctx));

      if (ssrBodyTemplate) {
        ctx.body = ssrBodyTemplate(ctx);
      } else {
        ctx.body = legacySSRBodyTemplate(ctx);
      }
    };
  };
}

function legacySSRBodyTemplate(ctx) {
  const {
    htmlAttrs,
    bodyAttrs,
    title,
    head,
    body
  } = ctx.template;
  const safeAttrs = Object.keys(htmlAttrs).map(attrKey => {
    return ` ${escape(attrKey)}="${escape(htmlAttrs[attrKey])}"`;
  }).join('');
  const safeBodyAttrs = Object.keys(bodyAttrs).map(attrKey => {
    return ` ${escape(attrKey)}="${escape(bodyAttrs[attrKey])}"`;
  }).join('');
  const safeTitle = escape(title);
  const safeHead = head.map(consumeSanitizedHTML).join('');
  const safeBody = body.map(consumeSanitizedHTML).join('');
  const preloadHintLinks = getPreloadHintLinks(ctx);
  const coreGlobals = getCoreGlobals(ctx);
  const chunkScripts = getChunkScripts(ctx);
  const bundleSplittingBootstrap = [preloadHintLinks, coreGlobals, chunkScripts].join('');
  return ['<!doctype html>', `<html${safeAttrs}>`, `<head>`, `<meta charset="utf-8" />`, `<title>${safeTitle}</title>`, `${bundleSplittingBootstrap}${safeHead}`, `</head>`, `<body${safeBodyAttrs}>${ctx.rendered}${safeBody}</body>`, '</html>'].join('');
}

function getCoreGlobals(ctx) {
  const {
    webpackPublicPath,
    nonce
  } = ctx;
  return [`<script nonce="${nonce}">`, `window.performance && window.performance.mark && window.performance.mark('firstRenderStart');`, `__ROUTE_PREFIX__ = ${JSON.stringify(ctx.prefix)};`, // consumed by ./client
  `__WEBPACK_PUBLIC_PATH__ = ${JSON.stringify(webpackPublicPath)};`, // consumed by fusion-clientries/client-entry
  `</script>`].join('');
}

function getUrls({
  chunkUrlMap,
  webpackPublicPath
}, chunks) {
  // cross origin is needed to get meaningful errors in window.onerror
  const isCrossOrigin = webpackPublicPath.startsWith('http');
  const crossOriginAttribute = isCrossOrigin ? ' crossorigin="anonymous"' : '';
  return [...new Set(chunks)].map(id => {
    let url = chunkUrlMap.get(id).get('es5');

    if (webpackPublicPath.endsWith('/')) {
      url = webpackPublicPath + url;
    } else {
      url = webpackPublicPath + '/' + url;
    }

    return {
      url,
      crossOriginAttribute
    };
  });
}

function getChunkScripts(ctx) {
  const sync = getUrls(ctx, ctx.syncChunks).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<script nonce="${ctx.nonce}" defer${crossOriginAttribute} src="${url}"></script>`;
  });
  const preloaded = getUrls(ctx, ctx.preloadChunks.filter(item => !ctx.syncChunks.includes(item))).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<script nonce="${ctx.nonce}" defer${crossOriginAttribute} src="${url}"></script>`;
  });
  return [...preloaded, ...sync].join('');
}

function getPreloadHintLinks(ctx) {
  const chunks = [...ctx.preloadChunks, ...ctx.syncChunks];
  const hints = getUrls(ctx, chunks).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<link rel="preload"${crossOriginAttribute} href="${url}" nonce="${ctx.nonce}" as="script" />`;
  });
  return hints.join('');
}

function getSerializedUniversalValues(ctx) {
  const app = ctx[appSymbol];
  return html`<script type="application/json" id="__FUSION_UNIVERSAL_VALUES__">
    ${JSON.stringify({ ...app.universalValues,
    ...ctx.universalValues
  })}
  </script>`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9wbHVnaW5zL3Nzci5qcyJdLCJuYW1lcyI6WyJjcmVhdGVQbHVnaW4iLCJlc2NhcGUiLCJjb25zdW1lU2FuaXRpemVkSFRNTCIsImh0bWwiLCJhcHBTeW1ib2wiLCJib3RSZWdleCIsIlNTUkRlY2lkZXIiLCJwcm92aWRlcyIsImN0eCIsInBhdGgiLCJtYXRjaCIsImhlYWRlcnMiLCJhZ2VudCIsInRlc3QiLCJtZXRob2QiLCJhY2NlcHQiLCJpbmNsdWRlcyIsImNyZWF0ZVNTUlBsdWdpbiIsImVuZHBvaW50cyIsInNzck1pZGRsZXdhcmUiLCJlbGVtZW50Iiwic3NyRGVjaWRlciIsInNzckJvZHlUZW1wbGF0ZSIsIm5leHQiLCJoYXMiLCJ0ZW1wbGF0ZSIsImh0bWxBdHRycyIsImJvZHlBdHRycyIsInRpdGxlIiwiaGVhZCIsImJvZHkiLCJyZW5kZXJlZCIsInR5cGUiLCJyZXNwb25kIiwicHVzaCIsImdldFNlcmlhbGl6ZWRVbml2ZXJzYWxWYWx1ZXMiLCJsZWdhY3lTU1JCb2R5VGVtcGxhdGUiLCJzYWZlQXR0cnMiLCJPYmplY3QiLCJrZXlzIiwibWFwIiwiYXR0cktleSIsImpvaW4iLCJzYWZlQm9keUF0dHJzIiwic2FmZVRpdGxlIiwic2FmZUhlYWQiLCJzYWZlQm9keSIsInByZWxvYWRIaW50TGlua3MiLCJnZXRQcmVsb2FkSGludExpbmtzIiwiY29yZUdsb2JhbHMiLCJnZXRDb3JlR2xvYmFscyIsImNodW5rU2NyaXB0cyIsImdldENodW5rU2NyaXB0cyIsImJ1bmRsZVNwbGl0dGluZ0Jvb3RzdHJhcCIsIndlYnBhY2tQdWJsaWNQYXRoIiwibm9uY2UiLCJKU09OIiwic3RyaW5naWZ5IiwicHJlZml4IiwiZ2V0VXJscyIsImNodW5rVXJsTWFwIiwiY2h1bmtzIiwiaXNDcm9zc09yaWdpbiIsInN0YXJ0c1dpdGgiLCJjcm9zc09yaWdpbkF0dHJpYnV0ZSIsIlNldCIsImlkIiwidXJsIiwiZ2V0IiwiZW5kc1dpdGgiLCJzeW5jIiwic3luY0NodW5rcyIsInByZWxvYWRlZCIsInByZWxvYWRDaHVua3MiLCJmaWx0ZXIiLCJpdGVtIiwiaGludHMiLCJhcHAiLCJ1bml2ZXJzYWxWYWx1ZXMiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUEsU0FBUUEsWUFBUixRQUEyQixrQkFBM0I7QUFDQSxTQUFRQyxNQUFSLEVBQWdCQyxvQkFBaEIsRUFBc0NDLElBQXRDLFFBQWlELGlCQUFqRDtBQUNBLFNBQVFDLFNBQVIsUUFBd0Isd0JBQXhCO0FBRUEsTUFBTUMsUUFBUSxHQUFHLHVCQUFqQjtBQUNBLE1BQU1DLFVBQVUsR0FBR04sWUFBWSxDQUFDO0FBQzlCTyxFQUFBQSxRQUFRLEVBQUUsTUFBTTtBQUNkLFdBQVFDLEdBQUQsSUFBUztBQUNkO0FBQ0E7QUFDQSxVQUFJQSxHQUFHLENBQUNDLElBQUosQ0FBU0MsS0FBVCxDQUFlLDBDQUFmLENBQUosRUFDRSxPQUFPLEtBQVAsQ0FKWSxDQU1kOztBQUNBLFVBQUlGLEdBQUcsQ0FBQ0csT0FBSixDQUFZLFlBQVosQ0FBSixFQUErQjtBQUM3QixjQUFNQyxLQUFLLEdBQUdKLEdBQUcsQ0FBQ0csT0FBSixDQUFZLFlBQVosQ0FBZDs7QUFDQSxZQUFJTixRQUFRLENBQUNRLElBQVQsQ0FBY0QsS0FBZCxLQUF3QkosR0FBRyxDQUFDTSxNQUFKLEtBQWUsS0FBM0MsRUFBa0Q7QUFDaEQsaUJBQU8sSUFBUDtBQUNEO0FBQ0YsT0FaYSxDQWNkO0FBQ0E7QUFDQTs7O0FBQ0EsVUFBSSxDQUFDTixHQUFHLENBQUNHLE9BQUosQ0FBWUksTUFBakIsRUFBeUIsT0FBTyxLQUFQO0FBQ3pCLFVBQUksQ0FBQ1AsR0FBRyxDQUFDRyxPQUFKLENBQVlJLE1BQVosQ0FBbUJDLFFBQW5CLENBQTRCLFdBQTVCLENBQUwsRUFBK0MsT0FBTyxLQUFQO0FBQy9DLGFBQU8sSUFBUDtBQUNELEtBcEJEO0FBcUJEO0FBdkI2QixDQUFELENBQS9CO0FBeUJBLFNBQVFWLFVBQVI7QUFFQSxlQUFl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Q29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQG5vZmxvd1xuICovXG5cbmltcG9ydCB7Y3JlYXRlUGx1Z2lufSBmcm9tICcuLi9jcmVhdGUtcGx1Z2luJztcbmltcG9ydCB7ZXNjYXBlLCBjb25zdW1lU2FuaXRpemVkSFRNTCwgaHRtbH0gZnJvbSAnLi4vc2FuaXRpemF0aW9uJztcbmltcG9ydCB7YXBwU3ltYm9sfSBmcm9tICcuLi91dGlscy9hcHAtc3ltYm9sLmpzJztcblxuY29uc3QgYm90UmVnZXggPSAvKGJvdHxjcmF3bGVyfHNwaWRlcikvaTtcbmNvbnN0IFNTUkRlY2lkZXIgPSBjcmVhdGVQbHVnaW4oe1xuICBwcm92aWRlczogKCkgPT4ge1xuICAgIHJldHVybiAoY3R4KSA9PiB7XG4gICAgICAvLyBJZiB0aGUgcmVxdWVzdCBoYXMgb25lIG9mIHRoZXNlIGV4dGVuc2lvbnMsIHdlIGFzc3VtZSBpdCdzIG5vdCBzb21ldGhpbmcgdGhhdCByZXF1aXJlcyBzZXJ2ZXItc2lkZSByZW5kZXJpbmcgb2YgdmlydHVhbCBkb21cbiAgICAgIC8vIFRPRE8oIzQ2KTogdGhpcyBjaGVjayBzaG91bGQgcHJvYmFibHkgbG9vayBhdCB0aGUgYXNzZXQgbWFuaWZlc3QgdG8gZW5zdXJlIGFzc2V0IDQwNHMgYXJlIGhhbmRsZWQgY29ycmVjdGx5XG4gICAgICBpZiAoY3R4LnBhdGgubWF0Y2goL1xcLihqc3xqc1xcLm1hcHxnaWZ8anBnfHBuZ3xwZGZ8anNvbnxzdmcpJC8pKVxuICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgIC8vIEJvdHMgZG9uJ3QgYWx3YXlzIGluY2x1ZGUgdGhlIGFjY2VwdCBoZWFkZXIuXG4gICAgICBpZiAoY3R4LmhlYWRlcnNbJ3VzZXItYWdlbnQnXSkge1xuICAgICAgICBjb25zdCBhZ2VudCA9IGN0eC5oZWFkZXJzWyd1c2VyLWFnZW50J107XG4gICAgICAgIGlmIChib3RSZWdleC50ZXN0KGFnZW50KSAmJiBjdHgubWV0aG9kID09PSAnR0VUJykge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFRoZSBBY2NlcHQgaGVhZGVyIGlzIGEgZ29vZCBwcm94eSBmb3Igd2hldGhlciBTU1Igc2hvdWxkIGhhcHBlblxuICAgICAgLy8gUmVxdWVzdGluZyBhbiBIVE1MIHBhZ2UgdmlhIHRoZSBicm93c2VyIHVybCBiYXIgZ2VuZXJhdGVzIGEgcmVxdWVzdCB3aXRoIGB0ZXh0L2h0bWxgIGluIGl0cyBBY2NlcHQgaGVhZGVyc1xuICAgICAgLy8gWEhSL2ZldGNoIHJlcXVlc3RzIGRvIG5vdCBoYXZlIGB0ZXh0L2h0bWxgIGluIHRoZSBBY2NlcHQgaGVhZGVyc1xuICAgICAgaWYgKCFjdHguaGVhZGVycy5hY2NlcHQpIHJldHVybiBmYWxzZTtcbiAgICAgIGlmICghY3R4LmhlYWRlcnMuYWNjZXB0LmluY2x1ZGVzKCd0ZXh0L2h0bWwnKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfTtcbiAgfSxcbn0pO1xuZXhwb3J0IHtTU1JEZWNpZGVyfTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY3JlYXRlU1NSUGx1Z2luKGVuZHBvaW50cykge1xuICByZXR1cm4gZnVuY3Rpb24gc3NyTWlkZGxld2FyZSh7ZWxlbWVudCwgc3NyRGVjaWRlciwgc3NyQm9keVRlbXBsYXRlfSkge1xuICAgIHJldHVybiBhc3luYyBmdW5jdGlvbiBzc3JNaWRkbGV3YXJlKGN0eCwgbmV4dCkge1xuICAgICAgaWYgKGVuZHBvaW50cy5oYXMoY3R4LnBhdGgpKSB7XG4gICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICB9XG4gICAgICBpZiAoIXNzckRlY2lkZXIoY3R4KSkgcmV0dXJuIG5leHQoKTtcblxuICAgICAgY29uc3QgdGVtcGxhdGUgPSB7XG4gICAgICAgIGh0bWxBdHRyczoge30sXG4gICAgICAgIGJvZHlBdHRyczoge30sXG4gICAgICAgIHRpdGxlOiAnJyxcbiAgICAgICAgaGVhZDogW10sXG4gICAgICAgIGJvZHk6IFtdLFxuICAgICAgfTtcbiAgICAgIGN0eC5lbGVtZW50ID0gZWxlbWVudDtcbiAgICAgIGN0eC5yZW5kZXJlZCA9ICcnO1xuICAgICAgY3R4LnRlbXBsYXRlID0gdGVtcGxhdGU7XG4gICAgICBjdHgudHlwZSA9ICd0ZXh0L2h0bWwnO1xuXG4gICAgICBhd2FpdCBuZXh0KCk7XG5cbiAgICAgIC8vIEFsbG93IHNvbWVvbmUgdG8gb3ZlcnJpZGUgdGhlIHNzciBieSBzZXR0aW5nIGN0eC5ib2R5XG4gICAgICAvLyBUaGlzIGlzIGVzcGVjaWFsbHkgdXNlZnVsIGZvciB0aGluZ3MgbGlrZSBjdHgucmVkaXJlY3RcbiAgICAgIGlmIChjdHguYm9keSAmJiBjdHgucmVzcG9uZCAhPT0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjdHgudGVtcGxhdGUuaGVhZC5wdXNoKGdldFNlcmlhbGl6ZWRVbml2ZXJzYWxWYWx1ZXMoY3R4KSk7XG5cbiAgICAgIGlmIChzc3JCb2R5VGVtcGxhdGUpIHtcbiAgICAgICAgY3R4LmJvZHkgPSBzc3JCb2R5VGVtcGxhdGUoY3R4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGN0eC5ib2R5ID0gbGVnYWN5U1NSQm9keVRlbXBsYXRlKGN0eCk7XG4gICAgICB9XG4gICAgfTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gbGVnYWN5U1NSQm9keVRlbXBsYXRlKGN0eCkge1xuICBjb25zdCB7aHRtbEF0dHJzLCBib2R5QXR0cnMsIHRpdGxlLCBoZWFkLCBib2R5fSA9IGN0eC50ZW1wbGF0ZTtcbiAgY29uc3Qgc2FmZUF0dHJzID0gT2JqZWN0LmtleXMoaHRtbEF0dHJzKVxuICAgIC5tYXAoKGF0dHJLZXkpID0+IHtcbiAgICAgIHJldHVybiBgICR7ZXNjYXBlKGF0dHJLZXkpfT1cIiR7ZXNjYXBlKGh0bWxBdHRyc1thdHRyS2V5XSl9XCJgO1xuICAgIH0pXG4gICAgLmpvaW4oJycpO1xuXG4gIGNvbnN0IHNhZmVCb2R5QXR0cnMgPSBPYmplY3Qua2V5cyhib2R5QXR0cnMpXG4gICAgLm1hcCgoYXR0cktleSkgPT4ge1xuICAgICAgcmV0dXJuIGAgJHtlc2NhcGUoYXR0cktleSl9PVwiJHtlc2NhcGUoYm9keUF0dHJzW2F0dHJLZXldKX1cImA7XG4gICAgfSlcbiAgICAuam9pbignJyk7XG5cbiAgY29uc3Qgc2FmZVRpdGxlID0gZXNjYXBlKHRpdGxlKTtcbiAgY29uc3Qgc2FmZUhlYWQgPSBoZWFkLm1hcChjb25zdW1lU2FuaXRpemVkSFRNTCkuam9pbignJyk7XG4gIGNvbnN0IHNhZmVCb2R5ID0gYm9keS5tYXAoY29uc3VtZVNhbml0aXplZEhUTUwpLmpvaW4oJycpO1xuXG4gIGNvbnN0IHByZWxvYWRIaW50TGlua3MgPSBnZXRQcmVsb2FkSGludExpbmtzKGN0eCk7XG4gIGNvbnN0IGNvcmVHbG9iYWxzID0gZ2V0Q29yZUdsb2JhbHMoY3R4KTtcbiAgY29uc3QgY2h1bmtTY3JpcHRzID0gZ2V0Q2h1bmtTY3JpcHRzKGN0eCk7XG4gIGNvbnN0IGJ1bmRsZVNwbGl0dGluZ0Jvb3RzdHJhcCA9IFtcbiAgICBwcmVsb2FkSGludExpbmtzLFxuICAgIGNvcmVHbG9iYWxzLFxuICAgIGNodW5rU2NyaXB0cyxcbiAgXS5qb2luKCcnKTtcblxuICByZXR1cm4gW1xuICAgICc8IWRvY3R5cGUgaHRtbD4nLFxuICAgIGA8aHRtbCR7c2FmZUF0dHJzfT5gLFxuICAgIGA8aGVhZD5gLFxuICAgIGA8bWV0YSBjaGFyc2V0PVwidXRmLThcIiAvPmAsXG4gICAgYDx0aXRsZT4ke3NhZmVUaXRsZX08L3RpdGxlPmAsXG4gICAgYCR7YnVuZGxlU3BsaXR0aW5nQm9vdHN0cmFwfSR7c2FmZUhlYWR9YCxcbiAgICBgPC9oZWFkPmAsXG4gICAgYDxib2R5JHtzYWZlQm9keUF0dHJzfT4ke2N0eC5yZW5kZXJlZH0ke3NhZmVCb2R5fTwvYm9keT5gLFxuICAgICc8L2h0bWw+JyxcbiAgXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0Q29yZUdsb2JhbHMoY3R4KSB7XG4gIGNvbnN0IHt3ZWJwYWNrUHVibGljUGF0aCwgbm9uY2V9ID0gY3R4O1xuXG4gIHJldHVybiBbXG4gICAgYDxzY3JpcHQgbm9uY2U9XCIke25vbmNlfVwiPmAsXG4gICAgYHdpbmRvdy5wZXJmb3JtYW5jZSAmJiB3aW5kb3cucGVyZm9ybWFuY2UubWFyayAmJiB3aW5kb3cucGVyZm9ybWFuY2UubWFyaygnZmlyc3RSZW5kZXJTdGFydCcpO2AsXG4gICAgYF9fUk9VVEVfUFJFRklYX18gPSAke0pTT04uc3RyaW5naWZ5KGN0eC5wcmVmaXgpfTtgLCAvLyBjb25zdW1lZCBieSAuL2NsaWVudFxuICAgIGBfX1dFQlBBQ0tfUFVCTElDX1BBVEhfXyA9ICR7SlNPTi5zdHJpbmdpZnkod2VicGFja1B1YmxpY1BhdGgpfTtgLCAvLyBjb25zdW1lZCBieSBmdXNpb24tY2xpZW50cmllcy9jbGllbnQtZW50cnlcbiAgICBgPC9zY3JpcHQ+YCxcbiAgXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0VXJscyh7Y2h1bmtVcmxNYXAsIHdlYnBhY2tQdWJsaWNQYXRofSwgY2h1bmtzKSB7XG4gIC8vIGNyb3NzIG9yaWdpbiBpcyBuZWVkZWQgdG8gZ2V0IG1lYW5pbmdmdWwgZXJyb3JzIGluIHdpbmRvdy5vbmVycm9yXG4gIGNvbnN0IGlzQ3Jvc3NPcmlnaW4gPSB3ZWJwYWNrUHVibGljUGF0aC5zdGFydHNXaXRoKCdodHRwJyk7XG4gIGNvbnN0IGNyb3NzT3JpZ2luQXR0cmlidXRlID0gaXNDcm9zc09yaWdpbiA/ICcgY3Jvc3NvcmlnaW49XCJhbm9ueW1vdXNcIicgOiAnJztcbiAgcmV0dXJuIFsuLi5uZXcgU2V0KGNodW5rcyldLm1hcCgoaWQpID0+IHtcbiAgICBsZXQgdXJsID0gY2h1bmtVcmxNYXAuZ2V0KGlkKS5nZXQoJ2VzNScpO1xuICAgIGlmICh3ZWJwYWNrUHVibGljUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgICB1cmwgPSB3ZWJwYWNrUHVibGljUGF0aCArIHVybDtcbiAgICB9IGVsc2Uge1xuICAgICAgdXJsID0gd2VicGFja1B1YmxpY1BhdGggKyAnLycgKyB1cmw7XG4gICAgfVxuICAgIHJldHVybiB7dXJsLCBjcm9zc09yaWdpbkF0dHJpYnV0ZX07XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRDaHVua1NjcmlwdHMoY3R4KSB7XG4gIGNvbnN0IHN5bmMgPSBnZXRVcmxzKGN0eCwgY3R4LnN5bmNDaHVua3MpLm1hcChcbiAgICAoe3VybCwgY3Jvc3NPcmlnaW5BdHRyaWJ1dGV9KSA9PiB7XG4gICAgICByZXR1cm4gYDxzY3JpcHQgbm9uY2U9XCIke2N0eC5ub25jZX1cIiBkZWZlciR7Y3Jvc3NPcmlnaW5BdHRyaWJ1dGV9IHNyYz1cIiR7dXJsfVwiPjwvc2NyaXB0PmA7XG4gICAgfVxuICApO1xuICBjb25zdCBwcmVsb2FkZWQgPSBnZXRVcmxzKFxuICAgIGN0eCxcbiAgICBjdHgucHJlbG9hZENodW5rcy5maWx0ZXIoKGl0ZW0pID0+ICFjdHguc3luY0NodW5rcy5pbmNsdWRlcyhpdGVtKSlcbiAgKS5tYXAoKHt1cmwsIGNyb3NzT3JpZ2luQXR0cmlidXRlfSkgPT4ge1xuICAgIHJldHVybiBgPHNjcmlwdCBub25jZT1cIiR7Y3R4Lm5vbmNlfVwiIGRlZmVyJHtjcm9zc09yaWdpbkF0dHJpYnV0ZX0gc3JjPVwiJHt1cmx9XCI+PC9zY3JpcHQ+YDtcbiAgfSk7XG4gIHJldHVybiBbLi4ucHJlbG9hZGVkLCAuLi5zeW5jXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0UHJlbG9hZEhpbnRMaW5rcyhjdHgpIHtcbiAgY29uc3QgY2h1bmtzID0gWy4uLmN0eC5wcmVsb2FkQ2h1bmtzLCAuLi5jdHguc3luY0NodW5rc107XG4gIGNvbnN0IGhpbnRzID0gZ2V0VXJscyhjdHgsIGNodW5rcykubWFwKCh7dXJsLCBjcm9zc09yaWdpbkF0dHJpYnV0ZX0pID0+IHtcbiAgICByZXR1cm4gYDxsaW5rIHJlbD1cInByZWxvYWRcIiR7Y3Jvc3NPcmlnaW5BdHRyaWJ1dGV9IGhyZWY9XCIke3VybH1cIiBub25jZT1cIiR7Y3R4Lm5vbmNlfVwiIGFzPVwic2NyaXB0XCIgLz5gO1xuICB9KTtcbiAgcmV0dXJuIGhpbnRzLmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBnZXRTZXJpYWxpemVkVW5pdmVyc2FsVmFsdWVzKGN0eCkge1xuICBjb25zdCBhcHAgPSBjdHhbYXBwU3ltYm9sXTtcbiAgcmV0dXJuIGh0bWxgPHNjcmlwdCB0eXBlPVwiYXBwbGljYXRpb24vanNvblwiIGlkPVwiX19GVVNJT05fVU5JVkVSU0FMX1ZBTFVFU19fXCI+XG4gICAgJHtKU09OLnN0cmluZ2lmeSh7Li4uYXBwLnVuaXZlcnNhbFZhbHVlcywgLi4uY3R4LnVuaXZlcnNhbFZhbHVlc30pfVxuICA8L3NjcmlwdD5gO1xufVxuIl19