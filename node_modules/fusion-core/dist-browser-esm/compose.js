/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
// inline version of koa-compose to get around Rollup/CUP commonjs-related issue
export function compose(middleware) {
  if (!Array.isArray(middleware)) {
    throw new TypeError('Middleware stack must be an array!');
  }

  for (const fn of middleware) {
    if (typeof fn !== 'function') {
      throw new TypeError(`Expected middleware function, received: ${typeof fn}`);
    }
  }

  return function (context, next) {
    let index = -1;
    return dispatch(0);

    function dispatch(i) {
      if (i <= index) {
        return Promise.reject(new Error('next() called multiple times'));
      }

      index = i;
      let fn = middleware[i];
      if (i === middleware.length) fn = next;
      if (!fn) return Promise.resolve();

      try {
        return fn(context, function next() {
          return dispatch(i + 1);
        });
      } catch (err) {
        return Promise.reject(err);
      }
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9jb21wb3NlLmpzIl0sIm5hbWVzIjpbImNvbXBvc2UiLCJtaWRkbGV3YXJlIiwiQXJyYXkiLCJpc0FycmF5IiwiVHlwZUVycm9yIiwiZm4iLCJjb250ZXh0IiwibmV4dCIsImluZGV4IiwiZGlzcGF0Y2giLCJpIiwiUHJvbWlzZSIsInJlamVjdCIsIkVycm9yIiwibGVuZ3RoIiwicmVzb2x2ZSIsImVyciJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFFQTtBQUNBLE9BQU8sU0FBU0EsT0FBVCxDQUFpQkMsVUFBakIsRUFBNkI7QUFDbEMsTUFBSSxDQUFDQyxLQUFLLENBQUNDLE9BQU4sQ0FBY0YsVUFBZCxDQUFMLEVBQWdDO0FBQzlCLFVBQU0sSUFBSUcsU0FBSixDQUFjLG9DQUFkLENBQU47QUFDRDs7QUFDRCxPQUFLLE1BQU1DLEVBQVgsSUFBaUJKLFVBQWpCLEVBQTZCO0FBQzNCLFFBQUksT0FBT0ksRUFBUCxLQUFjLFVBQWxCLEVBQThCO0FBQzVCLFlBQU0sSUFBSUQsU0FBSixDQUNILDJDQUEwQyxPQUFPQyxFQUFHLEVBRGpELENBQU47QUFHRDtBQUNGOztBQUVELFNBQU8sVUFBVUMsT0FBVixFQUFtQkMsSUFBbkIsRUFBeUI7QUFDOUIsUUFBSUMsS0FBSyxHQUFHLENBQUMsQ0FBYjtBQUNBLFdBQU9DLFFBQVEsQ0FBQyxDQUFELENBQWY7O0FBQ0EsYUFBU0EsUUFBVCxDQUFrQkMsQ0FBbEIsRUFBcUI7QUFDbkIsVUFBSUEsQ0FBQyxJQUFJRixLQUFULEVBQWdCO0FBQ2QsZUFBT0csT0FBTyxDQUFDQyxNQUFSLENBQWUsSUFBSUMsS0FBSixDQUFVLDhCQUFWLENBQWYsQ0FBUDtBQUNEOztBQUNETCxNQUFBQSxLQUFLLEdBQUdFLENBQVI7QUFDQSxVQUFJTCxFQUFFLEdBQUdKLFVBQVUsQ0FBQ1MsQ0FBRCxDQUFuQjtBQUNBLFVBQUlBLENBQUMsS0FBS1QsVUFBVSxDQUFDYSxNQUFyQixFQUE2QlQsRUFBRSxHQUFHRSxJQUFMO0FBQzdCLFVBQUksQ0FBQ0YsRUFBTCxFQUFTLE9BQU9NLE9BQU8sQ0FBQ0ksT0FBUixFQUFQOztBQUNULFVBQUk7QUFDRixlQUFPVixFQUFFLENBQUNDLE9BQUQsRUFBVSxTQUFTQyxJQUFULEdBQWdCO0FBQ2pDLGlCQUFPRSxRQUFRLENBQUNDLENBQUMsR0FBRyxDQUFMLENBQWY7QUFDRCxTQUZRLENBQVQ7QUFHRCxPQUpELENBSUUsT0FBT00sR0FBUCxFQUFZO0FBQ1osZUFBT0wsT0FBTyxDQUFDQyxNQUFSLENBQWVJLEdBQWYsQ0FBUDtBQUNEO0FBQ0Y7QUFDRixHQW5CRDtBQW9CRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBDb3B5cmlnaHQgKGMpIDIwMTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAbm9mbG93XG4gKi9cblxuLy8gaW5saW5lIHZlcnNpb24gb2Yga29hLWNvbXBvc2UgdG8gZ2V0IGFyb3VuZCBSb2xsdXAvQ1VQIGNvbW1vbmpzLXJlbGF0ZWQgaXNzdWVcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlKG1pZGRsZXdhcmUpIHtcbiAgaWYgKCFBcnJheS5pc0FycmF5KG1pZGRsZXdhcmUpKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcignTWlkZGxld2FyZSBzdGFjayBtdXN0IGJlIGFuIGFycmF5IScpO1xuICB9XG4gIGZvciAoY29uc3QgZm4gb2YgbWlkZGxld2FyZSkge1xuICAgIGlmICh0eXBlb2YgZm4gIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgIGBFeHBlY3RlZCBtaWRkbGV3YXJlIGZ1bmN0aW9uLCByZWNlaXZlZDogJHt0eXBlb2YgZm59YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZnVuY3Rpb24gKGNvbnRleHQsIG5leHQpIHtcbiAgICBsZXQgaW5kZXggPSAtMTtcbiAgICByZXR1cm4gZGlzcGF0Y2goMCk7XG4gICAgZnVuY3Rpb24gZGlzcGF0Y2goaSkge1xuICAgICAgaWYgKGkgPD0gaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignbmV4dCgpIGNhbGxlZCBtdWx0aXBsZSB0aW1lcycpKTtcbiAgICAgIH1cbiAgICAgIGluZGV4ID0gaTtcbiAgICAgIGxldCBmbiA9IG1pZGRsZXdhcmVbaV07XG4gICAgICBpZiAoaSA9PT0gbWlkZGxld2FyZS5sZW5ndGgpIGZuID0gbmV4dDtcbiAgICAgIGlmICghZm4pIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBmbihjb250ZXh0LCBmdW5jdGlvbiBuZXh0KCkge1xuICAgICAgICAgIHJldHVybiBkaXNwYXRjaChpICsgMSk7XG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbn1cbiJdfQ==